

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Gond">
  <meta name="keywords" content="">
  
    <meta name="description" content="常用三方库gjson快速使用先安装： 1go get github.com&#x2F;tidwall&#x2F;gjson  后使用： 1234567891011121314151617package mainimport (  &quot;fmt&quot;  &quot;github.com&#x2F;tidwall&#x2F;gjson&quot;)func main() &amp;#123;  json :&#x3D; &#96;&amp;#123;&quot;">
<meta property="og:type" content="article">
<meta property="og:title" content="常用三方库">
<meta property="og:url" content="http://gondmhd.github.io/2024/12/10/go/%E5%B8%B8%E7%94%A8%E4%B8%89%E6%96%B9%E5%BA%93/index.html">
<meta property="og:site_name" content="Gond">
<meta property="og:description" content="常用三方库gjson快速使用先安装： 1go get github.com&#x2F;tidwall&#x2F;gjson  后使用： 1234567891011121314151617package mainimport (  &quot;fmt&quot;  &quot;github.com&#x2F;tidwall&#x2F;gjson&quot;)func main() &amp;#123;  json :&#x3D; &#96;&amp;#123;&quot;">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://github.com/gondmhd/blogImage/blob/main/img/image-20240904161834137.png?raw=true">
<meta property="article:published_time" content="2024-12-10T09:36:28.538Z">
<meta property="article:modified_time" content="2024-12-10T09:36:28.539Z">
<meta property="article:author" content="Gond">
<meta property="article:tag" content="Go">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://github.com/gondmhd/blogImage/blob/main/img/image-20240904161834137.png?raw=true">
  
  
  
  <title>常用三方库 - Gond</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"gondmhd.github.io","root":"/","version":"1.9.5","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 6.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Gond</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>首页</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>归档</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>分类</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>标签</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>关于</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/default.png') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="常用三方库"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2024-12-10 17:36" pubdate>
          2024年12月10日 下午
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          54k 字
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          454 分钟
        
      </span>
    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">常用三方库</h1>
            
            
              <div class="markdown-body">
                
                <h1 id="常用三方库"><a href="#常用三方库" class="headerlink" title="常用三方库"></a>常用三方库</h1><h2 id="gjson"><a href="#gjson" class="headerlink" title="gjson"></a>gjson</h2><h3 id="快速使用"><a href="#快速使用" class="headerlink" title="快速使用"></a>快速使用</h3><p>先安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get github.com/tidwall/gjson<br></code></pre></td></tr></table></figure>

<p>后使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/tidwall/gjson&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  json := <span class="hljs-string">`&#123;&quot;name&quot;:&#123;&quot;first&quot;:&quot;li&quot;,&quot;last&quot;:&quot;dj&quot;&#125;,&quot;age&quot;:18&#125;`</span><br>  lastName := gjson.Get(json, <span class="hljs-string">&quot;name.last&quot;</span>)<br>  fmt.Println(<span class="hljs-string">&quot;last name:&quot;</span>, lastName.String())<br><br>  age := gjson.Get(json, <span class="hljs-string">&quot;age&quot;</span>)<br>  fmt.Println(<span class="hljs-string">&quot;age:&quot;</span>, age.Int())<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>使用很简单，只需要传入 JSON 串和要读取的键路径即可。注意一点细节，因为<code>gjson.Get()</code>函数实际上返回的是<code>gjson.Result</code>类型，我们要调用其相应的方法进行转换对应的类型。如上面的<code>String()</code>和<code>Int()</code>方法。</p>
<p>如果是直接打印输出，其实可以省略<code>String()</code>，<code>fmt</code>包的大部分函数都可以对实现<code>fmt.Stringer</code>接口的类型调用<code>String()</code>方法。</p>
<h3 id="键路径"><a href="#键路径" class="headerlink" title="键路径"></a>键路径</h3><p>键路径实际上是以<code>.</code>分隔的一系列键。<code>gjson</code>支持在键中包含通配符<code>*</code>和<code>?</code>，<code>*</code>匹配任意多个字符，<code>?</code>匹配单个字符，例如<code>ca*</code>可以匹配<code>cat/cate/cake</code>等以<code>ca</code>开头的键，<code>ca?</code>只能匹配<code>cat/cap</code>等以<code>ca</code>开头且后面只有一个字符的键。</p>
<p>数组使用<strong>键名 + <code>.</code> + 索引</strong>（索引从 0 开始）的方式读取元素，如果键<code>pets</code>对应的值是一个数组，那么<code>pets.0</code>读取数组的第一个元素，<code>pets.1</code>读取第二个元素。</p>
<p>数组长度使用<strong>键名 + <code>.</code> + <code>#</code></strong> 获取，例如<code>pets.#</code>返回数组<code>pets</code>的长度。</p>
<p>如果键名中出现<code>.</code>，那么需要使用<code>\</code>进行转义。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">const</span> json = <span class="hljs-string">`</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;name&quot;:&#123;&quot;first&quot;:&quot;Tom&quot;, &quot;last&quot;: &quot;Anderson&quot;&#125;,</span><br><span class="hljs-string">  &quot;age&quot;: 37,</span><br><span class="hljs-string">  &quot;children&quot;: [&quot;Sara&quot;, &quot;Alex&quot;, &quot;Jack&quot;],</span><br><span class="hljs-string">  &quot;fav.movie&quot;: &quot;Dear Hunter&quot;,</span><br><span class="hljs-string">  &quot;friends&quot;: [</span><br><span class="hljs-string">    &#123;&quot;first&quot;: &quot;Dale&quot;, &quot;last&quot;:&quot;Murphy&quot;, &quot;age&quot;: 44, &quot;nets&quot;: [&quot;ig&quot;, &quot;fb&quot;, &quot;tw&quot;]&#125;,</span><br><span class="hljs-string">    &#123;&quot;first&quot;: &quot;Roger&quot;, &quot;last&quot;: &quot;Craig&quot;, &quot;age&quot;: 68, &quot;nets&quot;: [&quot;fb&quot;, &quot;tw&quot;]&#125;,</span><br><span class="hljs-string">    &#123;&quot;first&quot;: &quot;Jane&quot;, &quot;last&quot;: &quot;Murphy&quot;, &quot;age&quot;: 47, &quot;nets&quot;: [&quot;ig&quot;, &quot;tw&quot;]&#125;</span><br><span class="hljs-string">  ]</span><br><span class="hljs-string">&#125;</span><br><span class="hljs-string">`</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  fmt.Println(<span class="hljs-string">&quot;last name:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;name.last&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;age:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;age&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;children:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;children&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;children count:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;children.#&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;second child:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;children.1&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;third child*:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;child*.2&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;first c?ild:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;c?ildren.0&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;fav.moive&quot;</span>, gjson.Get(json, <span class="hljs-string">`fav.\moive`</span>))<br>  fmt.Println(<span class="hljs-string">&quot;first name of friends:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;friends.#.first&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;last name of second friend:&quot;</span>, gjson.Get(json, <span class="hljs-string">&quot;friends.1.last&quot;</span>))<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>前 3 个比较简单，就不赘述了。看后面几个：</p>
<ul>
<li><code>children.#</code>：返回数组<code>children</code>的长度；</li>
<li><code>children.1</code>：读取数组<code>children</code>的第 2 个元素（注意索引从 0 开始）；</li>
<li><code>child*.2</code>：首先<code>child*</code>匹配<code>children</code>，<code>.2</code>读取第 3 个元素；</li>
<li><code>c?ildren.0</code>：<code>c?ildren</code>匹配到<code>children</code>，<code>.0</code>读取第一个元素；</li>
<li><code>fav.\moive</code>：因为键名中含有<code>.</code>，故需要<code>\</code>转义；</li>
<li><code>friends.#.first</code>：如果数组后<code>#</code>后还有内容，则以后面的路径读取数组中的每个元素，返回一个新的数组。所以该查询返回的数组所有<code>friends</code>的<code>first</code>字段组成；</li>
<li><code>friends.1.last</code>：读取<code>friends</code>第 2 个元素的<code>last</code>字段。</li>
</ul>
<p>运行结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go">last name: Anderson<br>age: <span class="hljs-number">37</span><br>children: [<span class="hljs-string">&quot;Sara&quot;</span>, <span class="hljs-string">&quot;Alex&quot;</span>, <span class="hljs-string">&quot;Jack&quot;</span>]<br>children count: <span class="hljs-number">3</span><br>second child: Alex<br>third child*: Jack<br>first c?ild: Sara<br>fave.moive <br>first name of friends: [<span class="hljs-string">&quot;Dale&quot;</span>,<span class="hljs-string">&quot;Roger&quot;</span>,<span class="hljs-string">&quot;Jane&quot;</span>]<br>last name of second friend: Craig<br></code></pre></td></tr></table></figure>

<p>对于数组，<code>gjson</code>还支持按条件查询元素，<code>#(条件)</code>返回第一个满足条件的元素，<code>#(条件)#</code>返回所有满足条件的元素。括号内的条件可以有<code>==</code>、<code>!=</code>、<code>&lt;</code>、<code>&lt;=</code>、<code>&gt;</code>、<code>&gt;=</code>，还有简单的模式匹配<code>%</code>（符合某个模式），<code>!%</code>（不符合某个模式）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go">fmt.Println(gjson.Get(json, <span class="hljs-string">`friends.#(last=&quot;Murphy&quot;).first`</span>))<br>fmt.Println(gjson.Get(json, <span class="hljs-string">`friends.#(last=&quot;Murphy&quot;)#.first`</span>))<br>fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;friends.#(age&gt;45)#.last&quot;</span>))<br>fmt.Println(gjson.Get(json, <span class="hljs-string">`friends.#(first%&quot;D*&quot;).last`</span>))<br>fmt.Println(gjson.Get(json, <span class="hljs-string">`friends.#(first!%&quot;D*&quot;).last`</span>))<br>fmt.Println(gjson.Get(json, <span class="hljs-string">`friends.#(nets.#(==&quot;fb&quot;))#.first`</span>))<br><br></code></pre></td></tr></table></figure>

<p>还是使用上面的 JSON 串。</p>
<ul>
<li><code>friends.#(last=&quot;Murphy&quot;).first</code>：<code>friends.#(last=&quot;Murphy&quot;)</code>返回数组<code>friends</code>中第一个<code>last</code>为<code>Murphy</code>的元素，<code>.first</code>表示取出该元素的<code>first</code>字段返回；</li>
<li><code>friends.#(last=&quot;Murphy&quot;)#.first</code>：<code>friends.#(last=&quot;Murphy&quot;)#</code>返回数组<code>friends</code>中所有的<code>last</code>为<code>Murphy</code>的元素，然后读取它们的<code>first</code>字段放在一个数组中返回。注意与上面一个的区别；</li>
<li><code>friends.#(age&gt;45)#.last</code>：<code>friends.#(age&gt;45)#</code>返回数组<code>friends</code>中所有年龄大于 45 的元素，然后读取它们的<code>last</code>字段返回；</li>
<li><code>friends.#(first%&quot;D*&quot;).last</code>：<code>friends.#(first%&quot;D*&quot;)</code>返回数组<code>friends</code>中第一个<code>first</code>字段满足模式<code>D*</code>的元素，取出其<code>last</code>字段返回；</li>
<li><code>friends.#(first!%&quot;D*&quot;).last</code>：&#96;&#96;friends.#(first!%”D_”)<code>返回数组</code>friends<code>中第一个</code>first<code>字段**不**满足模式</code>D_<code>的元素，读取其</code>last&#96;字段返回；</li>
<li><code>friends.#(nets.#(==&quot;fb&quot;))#.first</code>：这是个嵌套条件，<code>friends.#(nets.#(==&quot;fb&quot;))#</code>返回数组<code>friends</code>的元素的<code>nets</code>字段中有<code>fb</code>的所有元素，然后取出<code>first</code>字段返回。</li>
</ul>
<p>运行结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">Dale<br>[<span class="hljs-string">&quot;Dale&quot;</span>,<span class="hljs-string">&quot;Jane&quot;</span>]<br>[<span class="hljs-string">&quot;Craig&quot;</span>,<span class="hljs-string">&quot;Murphy&quot;</span>]<br>Murphy<br>Craig<br>[<span class="hljs-string">&quot;Dale&quot;</span>,<span class="hljs-string">&quot;Roger&quot;</span>]<br></code></pre></td></tr></table></figure>

<h3 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a>修饰符</h3><p><strong>修饰符</strong>是<code>gjson</code>提供的非常强大的功能，和键路径搭配使用。<code>gjson</code>提供了一些内置的修饰符：</p>
<ul>
<li><code>@reverse</code>：翻转一个数组；</li>
<li><code>@ugly</code>：移除 JSON 中的所有空白符；</li>
<li><code>@pretty</code>：使 JSON 更易用阅读；</li>
<li><code>@this</code>：返回当前的元素，可以用来返回根元素；</li>
<li><code>@valid</code>：校验 JSON 的合法性；</li>
<li><code>@flatten</code>：数组平坦化，即将<code>[&quot;a&quot;, [&quot;b&quot;, &quot;c&quot;]]</code>转为<code>[&quot;a&quot;,&quot;b&quot;,&quot;c&quot;]</code>；</li>
<li><code>@join</code>：将多个对象合并到一个对象中。</li>
</ul>
<p>修饰符的语法和管道类似，以<code>|</code>分隔键路径和分隔符。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> json = <span class="hljs-string">`&#123;</span><br><span class="hljs-string">  &quot;name&quot;:&#123;&quot;first&quot;:&quot;Tom&quot;, &quot;last&quot;: &quot;Anderson&quot;&#125;,</span><br><span class="hljs-string">  &quot;age&quot;: 37,</span><br><span class="hljs-string">  &quot;children&quot;: [&quot;Sara&quot;, &quot;Alex&quot;, &quot;Jack&quot;],</span><br><span class="hljs-string">  &quot;fav.movie&quot;: &quot;Dear Hunter&quot;,</span><br><span class="hljs-string">  &quot;friends&quot;: [</span><br><span class="hljs-string">    &#123;&quot;first&quot;: &quot;Dale&quot;, &quot;last&quot;:&quot;Murphy&quot;, &quot;age&quot;: 44, &quot;nets&quot;: [&quot;ig&quot;, &quot;fb&quot;, &quot;tw&quot;]&#125;,</span><br><span class="hljs-string">    &#123;&quot;first&quot;: &quot;Roger&quot;, &quot;last&quot;: &quot;Craig&quot;, &quot;age&quot;: 68, &quot;nets&quot;: [&quot;fb&quot;, &quot;tw&quot;]&#125;,</span><br><span class="hljs-string">    &#123;&quot;first&quot;: &quot;Jane&quot;, &quot;last&quot;: &quot;Murphy&quot;, &quot;age&quot;: 47, &quot;nets&quot;: [&quot;ig&quot;, &quot;tw&quot;]&#125;</span><br><span class="hljs-string">  ]</span><br><span class="hljs-string">&#125;`</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;children|@reverse&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;children|@reverse|0&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;friends|@ugly&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;friends|@pretty&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;@this&quot;</span>))<br><br>  nestedJSON := <span class="hljs-string">`&#123;&quot;nested&quot;: [&quot;one&quot;, &quot;two&quot;, [&quot;three&quot;, &quot;four&quot;]]&#125;`</span><br>  fmt.Println(gjson.Get(nestedJSON, <span class="hljs-string">&quot;nested|@flatten&quot;</span>))<br><br>  userJSON := <span class="hljs-string">`&#123;&quot;info&quot;:[&#123;&quot;name&quot;:&quot;dj&quot;, &quot;age&quot;:18&#125;,&#123;&quot;phone&quot;:&quot;123456789&quot;,&quot;email&quot;:&quot;dj@example.com&quot;&#125;]&#125;`</span><br>  fmt.Println(gjson.Get(userJSON, <span class="hljs-string">&quot;info|@join&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>children|@reverse</code>先读取数组<code>children</code>，然后使用修饰符<code>@reverse</code>翻转之后返回，输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">[<span class="hljs-string">&quot;Jack&quot;</span>,<span class="hljs-string">&quot;Alex&quot;</span>,<span class="hljs-string">&quot;Sara&quot;</span>]<br></code></pre></td></tr></table></figure>

<p><code>children|@reverse|0</code>在上面翻转的基础上读取第一个元素，即原数组的最后一个元素，输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">Jack<br></code></pre></td></tr></table></figure>

<p><code>friends|@ugly</code>移除<code>friends</code>数组中的所有空白字符，返回一行长长的字符串：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">[&#123;<span class="hljs-string">&quot;first&quot;</span>:<span class="hljs-string">&quot;Dale&quot;</span>,<span class="hljs-string">&quot;last&quot;</span>:<span class="hljs-string">&quot;Murphy&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">44</span>,<span class="hljs-string">&quot;nets&quot;</span>:[<span class="hljs-string">&quot;ig&quot;</span>,<span class="hljs-string">&quot;fb&quot;</span>,<span class="hljs-string">&quot;tw&quot;</span>]&#125;,&#123;<span class="hljs-string">&quot;first&quot;</span>:<span class="hljs-string">&quot;Roger&quot;</span>,<span class="hljs-string">&quot;last&quot;</span>:<span class="hljs-string">&quot;Craig&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">68</span>,<span class="hljs-string">&quot;nets&quot;</span>:[<span class="hljs-string">&quot;fb&quot;</span>,<span class="hljs-string">&quot;tw&quot;</span>]&#125;,&#123;<span class="hljs-string">&quot;first&quot;</span>:<span class="hljs-string">&quot;Jane&quot;</span>,<span class="hljs-string">&quot;last&quot;</span>:<span class="hljs-string">&quot;Murphy&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">47</span>,<span class="hljs-string">&quot;nets&quot;</span>:[<span class="hljs-string">&quot;ig&quot;</span>,<span class="hljs-string">&quot;tw&quot;</span>]&#125;]<br></code></pre></td></tr></table></figure>

<p><code>friends|@pretty</code>格式化<code>friends</code>数组，使之更易读：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">[</span><br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;first&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Dale&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;last&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Murphy&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">44</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;nets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;ig&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;fb&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;tw&quot;</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;first&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Roger&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;last&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Craig&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">68</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;nets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;fb&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;tw&quot;</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span> <br>  <span class="hljs-punctuation">&#123;</span><br>    <span class="hljs-attr">&quot;first&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Jane&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;last&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Murphy&quot;</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">47</span><span class="hljs-punctuation">,</span><br>    <span class="hljs-attr">&quot;nets&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-string">&quot;ig&quot;</span><span class="hljs-punctuation">,</span> <span class="hljs-string">&quot;tw&quot;</span><span class="hljs-punctuation">]</span><br>  <span class="hljs-punctuation">&#125;</span><br><span class="hljs-punctuation">]</span><br><br></code></pre></td></tr></table></figure>

<p><code>@this</code>返回原始的 JSON 串。</p>
<p><code>@flatten</code>将数组<code>nested</code>的内层数组平坦到外层后返回，即将所有内层数组的元素依次添加到外层数组后面并移除内层数组，输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">[<span class="hljs-string">&quot;one&quot;</span>,<span class="hljs-string">&quot;two&quot;</span>,<span class="hljs-string">&quot;three&quot;</span>, <span class="hljs-string">&quot;four&quot;</span>]<br></code></pre></td></tr></table></figure>

<p><code>@join</code>将一个数组中的各个对象合并到一个中，例子中将数组中存放的部分个人信息合并成一个对象返回：</p>
<figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs perl">&#123;<span class="hljs-string">&quot;name&quot;</span>:<span class="hljs-string">&quot;dj&quot;</span>,<span class="hljs-string">&quot;age&quot;</span>:<span class="hljs-number">18</span>,<span class="hljs-string">&quot;phone&quot;</span>:<span class="hljs-string">&quot;123456789&quot;</span>,<span class="hljs-string">&quot;email&quot;</span>:<span class="hljs-string">&quot;dj@example.com&quot;</span>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="修饰符参数"><a href="#修饰符参数" class="headerlink" title="修饰符参数"></a>修饰符参数</h3><p>修饰符还可以有参数，通过在修饰符后加<code>:</code>后跟参数。如果我们在格式化 JSON 串时，想要对键进行排序，那么可以使用<code>@pretty</code>修饰符的<code>sortKeys</code>参数。我们还是拿上面的 JSON 数据举例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span><br>fmt.Println(gjson.Get(json, <span class="hljs-string">`friends|@pretty:&#123;&quot;sortKeys&quot;:true&#125;`</span>))<br></code></pre></td></tr></table></figure>

<p>最终按键名顺序输出 JSON 串：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go">[<br>  &#123;<br>    <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">44</span>,<br>    <span class="hljs-string">&quot;first&quot;</span>: <span class="hljs-string">&quot;Dale&quot;</span>,<br>    <span class="hljs-string">&quot;last&quot;</span>: <span class="hljs-string">&quot;Murphy&quot;</span>,<br>    <span class="hljs-string">&quot;nets&quot;</span>: [<span class="hljs-string">&quot;ig&quot;</span>, <span class="hljs-string">&quot;fb&quot;</span>, <span class="hljs-string">&quot;tw&quot;</span>]<br>  &#125;, <br>  &#123;<br>    <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">68</span>,<br>    <span class="hljs-string">&quot;first&quot;</span>: <span class="hljs-string">&quot;Roger&quot;</span>,<br>    <span class="hljs-string">&quot;last&quot;</span>: <span class="hljs-string">&quot;Craig&quot;</span>,<br>    <span class="hljs-string">&quot;nets&quot;</span>: [<span class="hljs-string">&quot;fb&quot;</span>, <span class="hljs-string">&quot;tw&quot;</span>]<br>  &#125;, <br>  &#123;<br>    <span class="hljs-string">&quot;age&quot;</span>: <span class="hljs-number">47</span>,<br>    <span class="hljs-string">&quot;first&quot;</span>: <span class="hljs-string">&quot;Jane&quot;</span>,<br>    <span class="hljs-string">&quot;last&quot;</span>: <span class="hljs-string">&quot;Murphy&quot;</span>,<br>    <span class="hljs-string">&quot;nets&quot;</span>: [<span class="hljs-string">&quot;ig&quot;</span>, <span class="hljs-string">&quot;tw&quot;</span>]<br>  &#125;<br>]<br></code></pre></td></tr></table></figure>

<p>当然还可以指定每行缩进<code>indent</code>（默认两个空格），每行开头字符串<code>prefix</code>（默认为空串）和一行最多显示字符数<code>width</code>（默认 80 字符）。下面在每行前增加两个空格：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span><br><br>fmt.Println(gjson.Get(json, <span class="hljs-string">`friends|@pretty:&#123;&quot;sortKeys&quot;:true,&quot;prefix&quot;:&quot;  &quot;&#125;`</span>))<br></code></pre></td></tr></table></figure>

<h3 id="自定义修饰符"><a href="#自定义修饰符" class="headerlink" title="自定义修饰符"></a>自定义修饰符</h3><p>如此强大的功当然要支持自定义！<code>gjson</code>使用<code>AddModifier()</code>添加一个修饰符，传入一个名字和类型为<code>func(json arg string) string</code>的处理函数。处理函数接受待处理的 JSON 值和修饰符参数，返回处理后的结果。下面编写一个转换大小写的修饰符：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  gjson.AddModifier(<span class="hljs-string">&quot;case&quot;</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(json, arg <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">string</span> &#123;<br>    <span class="hljs-keyword">if</span> arg == <span class="hljs-string">&quot;upper&quot;</span> &#123;<br>      <span class="hljs-keyword">return</span> strings.ToUpper(json)<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> arg == <span class="hljs-string">&quot;lower&quot;</span> &#123;<br>      <span class="hljs-keyword">return</span> strings.ToLower(json)<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> json<br>  &#125;)<br><br>  <span class="hljs-keyword">const</span> json = <span class="hljs-string">`&#123;&quot;children&quot;: [&quot;Sara&quot;, &quot;Alex&quot;, &quot;Jack&quot;]&#125;`</span><br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;children|@case:upper&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;children|@case:lower&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">[<span class="hljs-string">&quot;SARA&quot;</span>, <span class="hljs-string">&quot;ALEX&quot;</span>, <span class="hljs-string">&quot;JACK&quot;</span>]<br>[<span class="hljs-string">&quot;sara&quot;</span>, <span class="hljs-string">&quot;alex&quot;</span>, <span class="hljs-string">&quot;jack&quot;</span>]<br></code></pre></td></tr></table></figure>

<h3 id="JSON-行"><a href="#JSON-行" class="headerlink" title="JSON 行"></a>JSON 行</h3><p><code>gjson</code>提供<code>..</code>语法可以将多行数据看成一个数组，每行数据是一个元素：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> json = <span class="hljs-string">`</span><br><span class="hljs-string">&#123;&quot;name&quot;: &quot;Gilbert&quot;, &quot;age&quot;: 61&#125;</span><br><span class="hljs-string">&#123;&quot;name&quot;: &quot;Alexa&quot;, &quot;age&quot;: 34&#125;</span><br><span class="hljs-string">&#123;&quot;name&quot;: &quot;May&quot;, &quot;age&quot;: 57&#125;</span><br><span class="hljs-string">&#123;&quot;name&quot;: &quot;Deloise&quot;, &quot;age&quot;: 44&#125;`</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;..#&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;..1&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;..#.name&quot;</span>))<br>  fmt.Println(gjson.Get(json, <span class="hljs-string">`..#(name=&quot;May&quot;).age`</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>..#</code>：返回有多少行 JSON 数据；</li>
<li><code>..1</code>：返回第一行，即<code>&#123;&quot;name&quot;: &quot;Gilbert&quot;, &quot;age&quot;: 61&#125;</code>；</li>
<li><code>..#.name</code>：<code>#</code>后再接路径，表示对数组中每个元素读取后面的路径，将读取到的值组成一个新数组返回；<code>..#.name</code>表示读取每一行中的<code>name</code>字段，最终返回<code>[&quot;Gilbert&quot;,&quot;Alexa&quot;,&quot;May&quot;,&quot;Deloise&quot;]</code>；</li>
<li><code>..#(name=&quot;May&quot;).age</code>：括号中的内容<code>(name=&quot;May&quot;)</code>表示条件，所以该条含义为取<code>name</code>为<code>&quot;May&quot;</code>的行中的<code>age</code>字段。</li>
</ul>
<p><code>gjson</code>还提供了遍历 JSON 行的方法：<code>gjson.ForEachLine()</code>，参数为 JSON 串和类型为<code>func(line gjson.Result) bool</code>的回调函数。回调返回<code>false</code>时遍历停止。下面代码读取输出每一行的<code>name</code>字段：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">gjson.ForEachLine(json, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(line gjson.Result)</span></span> <span class="hljs-type">bool</span> &#123;<br>  fmt.Println(<span class="hljs-string">&quot;name:&quot;</span>, gjson.Get(line.String(), <span class="hljs-string">&quot;name&quot;</span>))<br>  <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>&#125;)<br></code></pre></td></tr></table></figure>

<h3 id="遍历"><a href="#遍历" class="headerlink" title="遍历"></a>遍历</h3><p>上面我们介绍了遍历 JSON 行的方式，实际上<code>gjson</code>还提供了通用的遍历数组和对象的方式。<code>gjson.Get()</code>方法返回一个<code>gjson.Result</code>类型的对象，<code>json.Result</code>提供了<code>ForEach()</code>方法用于遍历。该方法接受一个类型为<code>func (key, value gjson.Result) bool</code>的回调函数。遍历对象时<code>key</code>和<code>value</code>分别为对象的键和值；遍历数组时，<code>value</code>为数组元素，<code>key</code>为空（<strong>不是索引</strong>）。回调返回<code>false</code>时，遍历停止。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> json = <span class="hljs-string">`</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;name&quot;:&quot;dj&quot;,</span><br><span class="hljs-string">  &quot;age&quot;:18,</span><br><span class="hljs-string">  &quot;pets&quot;: [&quot;cat&quot;, &quot;dog&quot;],</span><br><span class="hljs-string">  &quot;contact&quot;: &#123;</span><br><span class="hljs-string">    &quot;phone&quot;: &quot;123456789&quot;,</span><br><span class="hljs-string">    &quot;email&quot;: &quot;dj@example.com&quot;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;`</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  pets := gjson.Get(json, <span class="hljs-string">&quot;pets&quot;</span>)<br>  pets.ForEach(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(_, pet gjson.Result)</span></span> <span class="hljs-type">bool</span> &#123;<br>    fmt.Println(pet)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;)<br><br>  contact := gjson.Get(json, <span class="hljs-string">&quot;contact&quot;</span>)<br>  contact.ForEach(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(key, value gjson.Result)</span></span> <span class="hljs-type">bool</span> &#123;<br>    fmt.Println(key, value)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span><br>  &#125;)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="校验-JSON"><a href="#校验-JSON" class="headerlink" title="校验 JSON"></a>校验 JSON</h3><p>调用<code>gjson.Get()</code>时，<code>gjson</code>假设我们传入的 JSON 串是合法的。如果 JSON 非法也不会<code>panic</code>，这时会返回不确定的结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">const</span> json = <span class="hljs-string">`&#123;&quot;name&quot;:dj,age:18&#125;`</span><br>  fmt.Println(gjson.Get(json, <span class="hljs-string">&quot;name&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面 JSON 串是非法的，<code>dj</code>和<code>age</code>都没有加上双引号（实际上习惯了 Go 语言<code>map</code>的写法，很容易把 JSON 写成这样😭）。上面代码输出<strong>18</strong>，显然是错误的。我们可以使用<code>gjson.Valid()</code>检测 JSON 串是否合法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">if</span> !gjson.Valid(json) &#123;<br>  fmt.Println(<span class="hljs-string">&quot;error&quot;</span>)<br>&#125; <span class="hljs-keyword">else</span> &#123;<br>  fmt.Println(<span class="hljs-string">&quot;ok&quot;</span>)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="一次获取多个值"><a href="#一次获取多个值" class="headerlink" title="一次获取多个值"></a>一次获取多个值</h3><p>调用<code>gjson.Get()</code>一次只能读取一个值，多次调用又比较麻烦，<code>gjson</code>提供了<code>GetMany()</code>可以一次读取多个值，返回一个数组<code>[]gjson.Result</code>。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">const</span> json = <span class="hljs-string">`</span><br><span class="hljs-string">&#123;</span><br><span class="hljs-string">  &quot;name&quot;:&quot;dj&quot;,</span><br><span class="hljs-string">  &quot;age&quot;:18,</span><br><span class="hljs-string">  &quot;pets&quot;: [&quot;cat&quot;, &quot;dog&quot;],</span><br><span class="hljs-string">  &quot;contact&quot;: &#123;</span><br><span class="hljs-string">    &quot;phone&quot;: &quot;123456789&quot;,</span><br><span class="hljs-string">    &quot;email&quot;: &quot;dj@example.com&quot;</span><br><span class="hljs-string">  &#125;</span><br><span class="hljs-string">&#125;`</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  results := gjson.GetMany(json, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;age&quot;</span>, <span class="hljs-string">&quot;pets.#&quot;</span>, <span class="hljs-string">&quot;contact.phone&quot;</span>)<br>  <span class="hljs-keyword">for</span> _, result := <span class="hljs-keyword">range</span> results &#123;<br>    fmt.Println(result)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="Go-如何使用Resty"><a href="#Go-如何使用Resty" class="headerlink" title="Go - 如何使用Resty"></a>Go - 如何使用Resty</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p><code>RESTful API</code>已成为现代<code>Web</code>开发的基石，实现了客户端和服务器之间的无缝通信。在本文中，我们将探索使用<code>Resty</code>这个流行的<code>HTTP</code>客户端库在<code>Go</code>中执行常见操作，如<code>GET</code>、<code>POST</code>、<code>UPDATE</code>和<code>DELETE</code>请求的强大和简单性。我们还将学习如何在请求中传递头部，以便自定义和增强我们的<code>API</code>交互。</p>
<h3 id="安装Resty"><a href="#安装Resty" class="headerlink" title="安装Resty"></a>安装Resty</h3><p>首先，我们需要在<code>Go</code>环境中安装<code>Resty</code>。我们可以使用以下命令安装<code>Resty</code>包：</p>
<p>Bash</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get -u github.com/go-resty/resty/v2<br></code></pre></td></tr></table></figure>

<h3 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h3><h3 id="发起GET请求"><a href="#发起GET请求" class="headerlink" title="发起GET请求"></a>发起GET请求</h3><p>以下代码片段演示了一个简单的<code>GET</code>请求，并将响应绑定到一个结构体中：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/go-resty/resty/v2&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> DevUser <span class="hljs-keyword">struct</span> &#123;<br>    ID    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;id&quot;`</span><br>    Name  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>    Email <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> users []DevUser<br><br>    response, err := resty.New().R().SetResult(&amp;users).Get(<span class="hljs-string">&quot;https://api.example.com/users&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br><br>    fmt.Println(<span class="hljs-string">&quot;GET响应:&quot;</span>, response.Status())<br>    fmt.Printf(<span class="hljs-string">&quot;检索到%d个用户:\n&quot;</span>, <span class="hljs-built_in">len</span>(users))<br>    <span class="hljs-keyword">for</span> _, user := <span class="hljs-keyword">range</span> users &#123;<br>        fmt.Printf(<span class="hljs-string">&quot;用户ID：%d，姓名：%s，电子邮件：%s\n&quot;</span>, user.ID, user.Name, user.Email)<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="发起POST请求"><a href="#发起POST请求" class="headerlink" title="发起POST请求"></a>发起POST请求</h3><p>下面的示例演示了如何发送带有<code>JSON</code>负载的<code>POST</code>请求，并将响应绑定到结构体中：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/go-resty/resty/v2&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> DevUser <span class="hljs-keyword">struct</span> &#123;<br>    ID    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;id&quot;`</span><br>    Name  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>    Email <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> createdUser DevUser<br><br>    payload := DevUser&#123;<br>        Name:  <span class="hljs-string">&quot;John Doe&quot;</span>,<br>        Email: <span class="hljs-string">&quot;johndoe@example.com&quot;</span>,<br>    &#125;<br><br>    response, err := resty.New().R().<br>        SetHeader(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>).<br>        SetBody(&amp;payload).<br>        SetResult(&amp;createdUser).<br>        Post(<span class="hljs-string">&quot;https://api.example.com/users&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br><br>    fmt.Println(<span class="hljs-string">&quot;POST响应：&quot;</span>, response.Status())<br>    fmt.Printf(<span class="hljs-string">&quot;创建的用户：ID：%d，姓名：%s，电子邮件：%s\n&quot;</span>, createdUser.ID, createdUser.Name, createdUser.Email)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="发起UPDATE（PUT）请求"><a href="#发起UPDATE（PUT）请求" class="headerlink" title="发起UPDATE（PUT）请求"></a>发起UPDATE（PUT）请求</h3><p>下面的示例演示了如何发送带有<code>JSON</code>负载的<code>PUT</code>请求，并将响应绑定到结构体中：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/go-resty/resty/v2&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> DevUser <span class="hljs-keyword">struct</span> &#123;<br>    ID    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;id&quot;`</span><br>    Name  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>    Email <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> updatedUser DevUser<br><br>    payload := DevUser&#123;<br>        Name:  <span class="hljs-string">&quot;Updated Name&quot;</span>,<br>        Email: <span class="hljs-string">&quot;updated@example.com&quot;</span>,<br>    &#125;<br><br>    response, err := resty.New().R().<br>        SetHeader(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;application/json&quot;</span>).<br>        SetBody(&amp;payload).<br>        SetResult(&amp;updatedUser).<br>        Put(<span class="hljs-string">&quot;https://api.example.com/users/123&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br><br>    fmt.Println(<span class="hljs-string">&quot;PUT响应：&quot;</span>, response.Status())<br>    fmt.Printf(<span class="hljs-string">&quot;更新的用户：ID：%d，姓名：%s，电子邮件：%s\n&quot;</span>, updatedUser.ID, updatedUser.Name, updatedUser.Email)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="发起DELETE请求"><a href="#发起DELETE请求" class="headerlink" title="发起DELETE请求"></a>发起DELETE请求</h3><p>Go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/go-resty/resty/v2&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> DevUser <span class="hljs-keyword">struct</span> &#123;<br>    ID    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;id&quot;`</span><br>    Name  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>    Email <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    response, err := resty.New().R().Delete(<span class="hljs-string">&quot;https://api.example.com/users/123&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br><br>    fmt.Println(<span class="hljs-string">&quot;DELETE响应：&quot;</span>, response.Status())<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="传递头部"><a href="#传递头部" class="headerlink" title="传递头部"></a>传递头部</h3><p><code>Resty v2</code>允许我们在请求中包含自定义头部。下面的代码片段演示了如何使用<code>Resty v2</code>传递头部：</p>
<p>Go</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;log&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/go-resty/resty/v2&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> DevUser <span class="hljs-keyword">struct</span> &#123;<br>    ID    <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;id&quot;`</span><br>    Name  <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>    Email <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;email&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    client := resty.New()<br>    client.SetHeader(<span class="hljs-string">&quot;Authorization&quot;</span>, <span class="hljs-string">&quot;Bearer YOUR_TOKEN&quot;</span>)<br><br>    response, err := client.R().Get(<span class="hljs-string">&quot;https://api.example.com/protected-resource&quot;</span>)<br>    <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>        log.Fatal(err)<br>    &#125;<br><br>    fmt.Println(<span class="hljs-string">&quot;带有头部的GET响应：&quot;</span>, response.Status())<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>在这个全面的指南中，我们探索了如何利用<code>Resty v2</code>这个易于使用的<code>HTTP</code>客户端库，在<code>Go</code>中执行<code>GET</code>、<code>POST</code>、<code>UPDATE</code>和<code>DELETE</code>请求。我们还学习了如何传递头部以增强我们的<code>API</code>交互，提供更高的定制性和安全性。此外，我们还了解了如何将<code>API</code>响应绑定到<code>Go</code>结构体中，以便轻松处理和操作数据。<code>Resty v2</code>简化了<code>RESTful API</code>的使用，使我们能够专注于构建强大和高效的应用程序。</p>
<h2 id="sjson"><a href="#sjson" class="headerlink" title="sjson"></a>sjson</h2><h3 id="快速使用-1"><a href="#快速使用-1" class="headerlink" title="快速使用"></a>快速使用</h3><p>先安装：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">go get github.com/tidwall/sjson<br></code></pre></td></tr></table></figure>



<p>后使用：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/tidwall/sjson&quot;</span><br>)<br><br><span class="hljs-keyword">const</span> json = <span class="hljs-string">`&#123;&quot;name&quot;:&#123;&quot;first&quot;:&quot;li&quot;,&quot;last&quot;:&quot;dj&quot;&#125;,&quot;age&quot;:18&#125;`</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  value, _ := sjson.Set(json, <span class="hljs-string">&quot;name.last&quot;</span>, <span class="hljs-string">&quot;dajun&quot;</span>)<br>  fmt.Println(value)<br>&#125;<br></code></pre></td></tr></table></figure>



<p>上面代码通过<code>sjson.Set()</code>将 JSON 串中<code>name.last</code>对应的值设置为<code>dajun</code>。与<code>gjson</code>一样，<code>sjson</code>也通过<strong>键路径</strong>指定具体的位置，键路径即为一系列以<code>.</code>分隔的键。<code>sjson</code>支持的键路径语法是<code>gjson</code>的一个子集，sjson.Set()&#96;返回设置之后的 JSON 串。最终程序输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs json">`<span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;name&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-punctuation">&#123;</span><span class="hljs-attr">&quot;first&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;li&quot;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;last&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-string">&quot;dajun&quot;</span><span class="hljs-punctuation">&#125;</span><span class="hljs-punctuation">,</span><span class="hljs-attr">&quot;age&quot;</span><span class="hljs-punctuation">:</span><span class="hljs-number">18</span><span class="hljs-punctuation">&#125;</span> `<br></code></pre></td></tr></table></figure>



<h3 id="支持的类型"><a href="#支持的类型" class="headerlink" title="支持的类型"></a>支持的类型</h3><p><code>sjson</code>支持的类型包括<code>nil/bool/int/float/string</code>等。如果传入<code>sjson</code>不支持的类型，<code>sjson</code>会调用<code>json.Marshal</code>，然后将生成的字符串设置到对应的键路径上：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> User <span class="hljs-keyword">struct</span> &#123;<br>  Name <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;name&quot;`</span><br>  Age  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;age&quot;`</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  nilJSON, _ := sjson.Set(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-literal">nil</span>)<br>  fmt.Println(nilJSON)<br><br>  boolJSON, _ := sjson.Set(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-literal">false</span>)<br>  fmt.Println(boolJSON)<br><br>  intJSON, _ := sjson.Set(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-number">1</span>)<br>  fmt.Println(intJSON)<br><br>  floatJSON, _ := sjson.Set(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-number">10.5</span>)<br>  fmt.Println(floatJSON)<br><br>  strJSON, _ := sjson.Set(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-string">&quot;hello&quot;</span>)<br>  fmt.Println(strJSON)<br><br>  mapJSON, _ := sjson.Set(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>, <span class="hljs-keyword">map</span>[<span class="hljs-type">string</span>]<span class="hljs-keyword">interface</span>&#123;&#125;&#123;<span class="hljs-string">&quot;hello&quot;</span>: <span class="hljs-string">&quot;world&quot;</span>&#125;)<br>  fmt.Println(mapJSON)<br><br>  u := User&#123;Name: <span class="hljs-string">&quot;dj&quot;</span>, Age: <span class="hljs-number">18</span>&#125;<br>  structJSON, _ := sjson.Set(<span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;key&quot;</span>, u)<br>  fmt.Println(structJSON)<br>&#125;<br></code></pre></td></tr></table></figure>



<p>注意，我们传入一个空字符串，<code>sjson.Set()</code>会生成一个空对象，然后按照键路径依次设置值。下面分析上述程序输出：</p>
<ul>
<li><code>nil</code>：在 JSON 中用<code>null</code>表示，输出<code>&#123;&quot;key&quot;:null&#125;</code>；</li>
<li><code>false</code>：在 JSON 中布尔值用<code>true/false</code>表示，输出<code>&#123;&quot;key&quot;:false&#125;</code>；</li>
<li><code>1</code>和<code>10.5</code>：整数和浮点数在 JSON 中都用<code>number</code>表示，分别输出<code>&#123;&quot;key&quot;:1&#125;</code>和<code>&#123;&quot;key&quot;:10.5&#125;</code>；</li>
<li><code>hello</code>：输出<code>&#123;&quot;key&quot;:&quot;hello&quot;&#125;</code>；</li>
<li><code>map[string]interface&#123;&#125;</code>：<code>sjson</code>并不原生支持<code>map</code>类型，故通过<code>json.Marshal</code>将其序列化为<code>&#123;&quot;hello&quot;:&quot;world&quot;&#125;</code>再设置到键<code>key</code>上，输出<code>&#123;&quot;key&quot;:&#123;&quot;hello&quot;:&quot;world&quot;&#125;&#125;</code>；</li>
<li><code>User</code>对象：先通过<code>json.Marshal</code>序列化为<code>&#123;&quot;name&quot;:&quot;dj&quot;,&quot;age&quot;:18&#125;</code>再设置；</li>
</ul>
<h3 id="修改数组"><a href="#修改数组" class="headerlink" title="修改数组"></a>修改数组</h3><p>修改数组可以通过在键路径后添加索引，有两种特殊情况：</p>
<ul>
<li>使用<code>-1</code>或数组长度为索引表示在数组后添加一个新元素；</li>
<li>使用的索引超出数组的长度，会在数组中添加很多<code>null</code>值。</li>
</ul>
<p>看下面示例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  fruits := <span class="hljs-string">`&#123;&quot;fruits&quot;:[&quot;apple&quot;, &quot;orange&quot;, &quot;banana&quot;]&#125;`</span><br><br>  <span class="hljs-keyword">var</span> newValue <span class="hljs-type">string</span><br>  newValue, _ = sjson.Set(fruits, <span class="hljs-string">&quot;fruits.1&quot;</span>, <span class="hljs-string">&quot;grape&quot;</span>)<br>  fmt.Println(newValue)<br><br>  newValue, _ = sjson.Set(fruits, <span class="hljs-string">&quot;fruits.3&quot;</span>, <span class="hljs-string">&quot;pear&quot;</span>)<br>  fmt.Println(newValue)<br><br>  newValue, _ = sjson.Set(fruits, <span class="hljs-string">&quot;fruits.-1&quot;</span>, <span class="hljs-string">&quot;strawberry&quot;</span>)<br>  fmt.Println(newValue)<br><br>  newValue, _ = sjson.Set(fruits, <span class="hljs-string">&quot;fruits.5&quot;</span>, <span class="hljs-string">&quot;watermelon&quot;</span>)<br>  fmt.Println(newValue)<br>&#125;<br></code></pre></td></tr></table></figure>



<ul>
<li><code>fruits.1</code>：设置第二个水果为<code>grape</code>（<strong>索引从 0 开始</strong>），输出<code>&#123;&quot;fruits&quot;:[&quot;apple&quot;, &quot;grape&quot;, &quot;banana&quot;]&#125;</code>；</li>
<li><code>fruits.3</code>：由于数组长度为 3，使用 3 表示在数组后添加一个元素，输出<code>&#123;&quot;fruits&quot;:[&quot;apple&quot;,&quot;orange&quot;,&quot;banana&quot;,&quot;pear&quot;]&#125;</code>；</li>
<li><code>fruits.-1</code>：使用<code>-1</code>同样表示在数组后添加一个元素，输出<code>&#123;&quot;fruits&quot;:[&quot;apple&quot;, &quot;orange&quot;, &quot;banana&quot;,&quot;strawberry&quot;]&#125;</code>;</li>
<li><code>fruits.5</code>：索引 5 已经大于数组长度 3 了，所以会多出两个<code>null</code>，输出<code>&#123;&quot;fruits&quot;:[&quot;apple&quot;,&quot;orange&quot;,&quot;banana&quot;,null,null,&quot;watermelon&quot;]&#125;</code>。</li>
</ul>
<h3 id="删除"><a href="#删除" class="headerlink" title="删除"></a>删除</h3><p>删除数组元素需要调用<code>sjson.Delete()</code>方法，键路径语法相同。如果键路径对应的值不存在，则<code>Delete()</code>无效果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">var</span> newValue <span class="hljs-type">string</span><br>  user := <span class="hljs-string">`&#123;&quot;name&quot;:&#123;&quot;first&quot;:&quot;li&quot;,&quot;last&quot;:&quot;dj&quot;&#125;,&quot;age&quot;:18&#125;`</span><br><br>  newValue, _ = sjson.Delete(user, <span class="hljs-string">&quot;name.first&quot;</span>)<br>  fmt.Println(newValue)<br><br>  newValue, _ = sjson.Delete(user, <span class="hljs-string">&quot;name.full&quot;</span>)<br>  fmt.Println(newValue)<br><br>  fruits := <span class="hljs-string">`&#123;&quot;fruits&quot;:[&quot;apple&quot;, &quot;orange&quot;, &quot;banana&quot;]&#125;`</span><br><br>  newValue, _ = sjson.Delete(fruits, <span class="hljs-string">&quot;fruits.1&quot;</span>)<br>  fmt.Println(newValue)<br><br>  newValue, _ = sjson.Delete(fruits, <span class="hljs-string">&quot;fruits.-1&quot;</span>)<br>  fmt.Println(newValue)<br><br>  newValue, _ = sjson.Delete(fruits, <span class="hljs-string">&quot;fruits.5&quot;</span>)<br>  fmt.Println(newValue)<br>&#125;<br></code></pre></td></tr></table></figure>



<ul>
<li><code>name.first</code>：删除字段<code>name.first</code>，输出<code>&#123;&quot;name&quot;:&#123;&quot;last&quot;:&quot;dj&quot;&#125;,&quot;age&quot;:18&#125;</code>；</li>
<li><code>name.full</code>：由于字段<code>name.full</code>不存在，无效果，输出<code>&#123;&quot;name&quot;:&#123;&quot;first&quot;:&quot;li&quot;,&quot;last&quot;:&quot;dj&quot;&#125;,&quot;age&quot;:18&#125;</code>；</li>
<li><code>fruits.1</code>：删除数组<code>fruits</code>的第二个元素，输出<code>&#123;&quot;fruits&quot;:[&quot;apple&quot;, &quot;banana&quot;]&#125;</code>；</li>
<li><code>fruits.-1</code>：删除数组最后一个元素，输出<code>&#123;&quot;fruits&quot;:[&quot;apple&quot;, &quot;orange&quot;]&#125;</code>；</li>
<li><code>fruits.5</code>：索引 5 超出数组长度 3，无效果，输出<code>&#123;&quot;fruits&quot;:[&quot;apple&quot;, &quot;orange&quot;, &quot;banana&quot;]&#125;</code>。</li>
</ul>
<h3 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h3><p>使用<code>sjson</code>出现的错误分为两种，一种是传入的 JSON 串不是合法的串，另一种是键路径语法错误。<code>Set()</code>和<code>Delete()</code>方法返回的第二个参数为错误，只有非法的键路径会返回错误，非法 JSON 串不会。</p>
<h3 id="非法-JSON-串"><a href="#非法-JSON-串" class="headerlink" title="非法 JSON 串"></a>非法 JSON 串</h3><p>同<code>gjson</code>一样，<code>sjson</code>同样不会检查传入的 JSON 串的合法性，它假设传入的是合法的串。如果传入一个非法的 JSON 串，程序输出不确定的结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  user := <span class="hljs-string">`&#123;&quot;name&quot;:dj,age:18&#125;`</span><br>  newValue, err := sjson.Set(user, <span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;dajun&quot;</span>)<br>  fmt.Println(err, newValue)<br>&#125;<br></code></pre></td></tr></table></figure>



<p>上面程序中，我故意传入一个非法的 JSON 串（<code>dj</code>和<code>age</code>漏掉了双引号）。最终程序输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">&lt;<span class="hljs-literal">nil</span>&gt; &#123;<span class="hljs-string">&quot;name&quot;</span>:dj,age:<span class="hljs-string">&quot;dajun&quot;</span>&#125;<br></code></pre></td></tr></table></figure>



<p>将<code>age</code>变为了<code>dajun</code>，显然不正确。然而此时返回的<code>err = nil</code>。</p>
<h3 id="非法键路径"><a href="#非法键路径" class="headerlink" title="非法键路径"></a>非法键路径</h3><p>与<code>gjson</code>相比，<code>sjson</code>能使用的键路径语法比较有限，不能使用通配符和一些条件语法。如果传入的键路径非法，将返回非空的错误值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  user := <span class="hljs-string">`&#123;&quot;name&quot;:&quot;dj&quot;,&quot;age&quot;:18&#125;`</span><br>  newValue, err := sjson.Set(user, <span class="hljs-string">&quot;na?e&quot;</span>, <span class="hljs-string">&quot;dajun&quot;</span>)<br>  fmt.Println(err, newValue)<br>&#125;<br></code></pre></td></tr></table></figure>



<p>上次使用通配符<code>?</code>，输出：</p>
<figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs text"><br>wildcard characters not allowed in path <br><br></code></pre></td></tr></table></figure>



<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p><code>sjson</code>比较简单易用，性能不俗。我们在确定 JSON 串合法的情况下，可使用它快速设置值。</p>
<h2 id="Pie"><a href="#Pie" class="headerlink" title="Pie"></a>Pie</h2><p>在Go语言中，对slice和map是我们最常用的数据结构。比如，计算两个切片的交集、差集；判断切片中的元素是否都满足某个条件的等。我推荐大家使用这个包：<code>[elliotchance/pie](https://github.com/elliotchance/pie)</code>。</p>
<p>该包封装了<strong>对切片和map的常用操作,能满足工作中的大部分需求</strong>。比如计算切片的交集、差集；对切片中元素按条件过滤的Filter函数；对切片中元素进行数据转换的Each、Map函数等。</p>
<p>同时具有<strong>高性能</strong>、<strong>类型安全</strong>的特点。实现中对各函数的参数都做了类型的限制。比如Average函数就只能对整型和浮点型参数有效。</p>
<h3 id="使用pie包的要求："><a href="#使用pie包的要求：" class="headerlink" title="使用pie包的要求："></a>使用pie包的要求：</h3><p>pie v2版本需要Go 1.18+。Go1.17及以下版本需要使用v1版本。</p>
<h3 id="pie包的目标："><a href="#pie包的目标：" class="headerlink" title="pie包的目标："></a>pie包的目标：</h3><ul>
<li><strong>类型安全</strong>：无论是在v1版本还是v2版本的泛型中，都对类型做了限制，所以不会遇到运行时类型错误。</li>
<li><strong>高性能</strong>：该库需要跟原生的Go实现一样快，否则该库封装就没有意义。</li>
<li><strong>Nil安全</strong>：该库的所有函数都能接收nil参数，并将其视为空切片，而不会引起panic。</li>
<li><strong>对原切片无副作用</strong>：所有的函数对传入的切片参数都不会做修改。</li>
</ul>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><p>go 版本在1.18及以上，会使用pie&#x2F;v2包，该包使用的是泛型。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span>复制代码<span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/elliotchance/pie/v2&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br><br>    name := pie.Of([]<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-string">&quot;Sally&quot;</span>, <span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-string">&quot;Jane&quot;</span>&#125;).<br>    FilterNot(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">return</span> strings.HasPrefix(name, <span class="hljs-string">&quot;J&quot;</span>)<br>    &#125;).<br>    Map(strings.ToUpper).<br>    Last()<br><br>    fmt.Println(name) <span class="hljs-comment">// &quot;SALLY&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>go1.17及以下版本需要使用pie&#x2F;v1包。因为在1.17之前go还不支持泛型，所以函数只能针对特定类型的切片。在该v1包中，pie实际上是定义了一组类型切片。比如，代表string切片的pie.Strings类型。代表float64切片的pie.Float64s类型。那么该版本在使用时需要先定义切片的类型。如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span>复制代码<span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>    <span class="hljs-string">&quot;fmt&quot;</span><br>    <span class="hljs-string">&quot;strings&quot;</span><br><br>    <span class="hljs-string">&quot;github.com/elliotchance/pie/pie&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>    <span class="hljs-keyword">var</span> names pie.Strings <span class="hljs-comment">//看pie的源码Strings的底层类型是[]string</span><br>    names = []<span class="hljs-type">string</span>&#123;<span class="hljs-string">&quot;Bob&quot;</span>, <span class="hljs-string">&quot;Sally&quot;</span>, <span class="hljs-string">&quot;John&quot;</span>, <span class="hljs-string">&quot;Jane&quot;</span>&#125;<br><br>    name := names.FilterNot(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(name <span class="hljs-type">string</span>)</span></span> <span class="hljs-type">bool</span> &#123;<br>        <span class="hljs-keyword">return</span> strings.HasPrefix(name, <span class="hljs-string">&quot;J&quot;</span>)<br>    &#125;).<br>    Map(strings.ToUpper).<br>    Last()<br><br>    fmt.Println(name) <span class="hljs-comment">// &quot;SALLY&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="pie包支持的功能："><a href="#pie包支持的功能：" class="headerlink" title="pie包支持的功能："></a>pie包支持的功能：</h3><ul>
<li>切片中的元素是否全部或任意一个满足指定的条件。</li>
<li>All函数：判断切片中的元素是否都满足指定的条件。</li>
<li>Any函数：判断切片中的元素只要有1个满足指定条件即可。</li>
<li>对切片元素进行排序功能。</li>
<li>AreSorted函数：判断切片是否是有序的</li>
<li>Sort函数：对切片元素进行排序。</li>
<li>SortStableUsing函数：使用指定的条件对切片进行排序，并且具有稳定性。</li>
<li>SortUsing函数</li>
<li>对切片中的元素去重。</li>
<li>判断切片中的元素是否不重复的AreUnique函数、去重函数Unique</li>
<li>对切片进行前、后截取。</li>
<li>Bottom函数：取切片后n个元素</li>
<li>Top函数：取切片前n个元素</li>
<li>DropTop函数：丢掉切片的前n个元素，并返回剩余的元素切片</li>
<li>两个或多个切片之间的集合运算</li>
<li>Diff函数：计算两个切片中的差集</li>
<li>Intersect函数：计算两个或多个切片的交集</li>
<li>切片元素进行算数运算功能（只针对Integer和float类型的切片有效）。</li>
<li>Max函数：返回切片中的最大元素</li>
<li>Min函数：返回切片中的最小元素</li>
<li>Product函数：对切片所有元素进行乘积运算</li>
<li>Sum函数：对切片中所有元素进行求和运算</li>
<li>Average函数：求所有元素的平均值</li>
<li>对切片中的元素进行数据转换功能：Each、Map、Filter、Flat、Reducer</li>
<li>针对map的操作：</li>
<li>Keys函数：获取map的所有键</li>
<li>Values函数：获取map的所有值</li>
</ul>
<p>更多、更详细的功能请参考pie包的源码。</p>
<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>pie包几乎把slice经常用到的功能都做了封装，可谓是给开发者节省了大量时间。同时，v2包利用了泛型中的类型限制，保证了类型的安全。在性能方面，该包采用了很多策略：在已知切片长度的情况下尽可能给slice<strong>分配固定长度</strong>的内存，减少在使用append时内存申请的次数；使用<strong>切片截取</strong>的形式，避免内存再次分配。</p>
<h2 id="Viper"><a href="#Viper" class="headerlink" title="Viper"></a>Viper</h2><p>viper是go一个强大的流行的配置解决方案的库。viper是spf13的另外一个重量级库。有大量项目都使用该库，比如hugo, docker等。 它基本上可以处理所有类型的配置需求和格式, viper支持功能</p>
<ul>
<li><p>支持 JSON&#x2F;TOML&#x2F;YAML&#x2F;HCL&#x2F;envfile&#x2F;Java properties 等多种格式的配置文件；</p>
</li>
<li><p>可以设置监听配置文件的修改，修改时自动加载新的配置；</p>
</li>
<li><p>从环境变量、命令行选项和<code>io.Reader</code>中读取配置；</p>
</li>
<li><p>从远程配置系统中读取和监听修改，如 etcd&#x2F;Consul；</p>
</li>
<li><p>代码逻辑中显示设置键值。</p>
</li>
</ul>
<h3 id="快速使用-2"><a href="#快速使用-2" class="headerlink" title="快速使用"></a>快速使用</h3><p>安装</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> get github.com/spf13/viper<br></code></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br>  <span class="hljs-string">&quot;log&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  viper.SetConfigName(<span class="hljs-string">&quot;config&quot;</span>)<br>  viper.SetConfigType(<span class="hljs-string">&quot;toml&quot;</span>)<br>  viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)<br>  viper.SetDefault(<span class="hljs-string">&quot;redis.port&quot;</span>, <span class="hljs-number">6381</span>)			# 默认值可以调用viper.SetDefault设置<br>  err := viper.ReadInConfig()<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    log.Fatal(<span class="hljs-string">&quot;read config failed: %v&quot;</span>, err)<br>  &#125;<br><br>  fmt.Println(viper.Get(<span class="hljs-string">&quot;app_name&quot;</span>))<br>  fmt.Println(viper.Get(<span class="hljs-string">&quot;log_level&quot;</span>))<br><br>  fmt.Println(<span class="hljs-string">&quot;mysql ip: &quot;</span>, viper.Get(<span class="hljs-string">&quot;mysql.ip&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;mysql port: &quot;</span>, viper.Get(<span class="hljs-string">&quot;mysql.port&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;mysql user: &quot;</span>, viper.Get(<span class="hljs-string">&quot;mysql.user&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;mysql password: &quot;</span>, viper.Get(<span class="hljs-string">&quot;mysql.password&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;mysql database: &quot;</span>, viper.Get(<span class="hljs-string">&quot;mysql.database&quot;</span>))<br><br>  fmt.Println(<span class="hljs-string">&quot;redis ip: &quot;</span>, viper.Get(<span class="hljs-string">&quot;redis.ip&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;redis port: &quot;</span>, viper.Get(<span class="hljs-string">&quot;redis.port&quot;</span>))<br>&#125;<br><br></code></pre></td></tr></table></figure>

<h3 id="读取键"><a href="#读取键" class="headerlink" title="读取键"></a>读取键</h3><p>viper 提供了多种形式的读取方法。在上面的例子中，我们看到了<code>Get</code>方法的用法。<code>Get</code>方法返回一个<code>interface&#123;&#125;</code>的值，使用有所不便。</p>
<p><code>GetType</code>系列方法可以返回指定类型的值。 其中，Type 可以为<code>Bool/Float64/Int/String/Time/Duration/IntSlice/StringSlice</code>。 但是请注意，</p>
<p><strong>如果指定的键不存在或类型不正确，<code>GetType</code>方法返回对应类型的零值</strong>。</p>
<p>如果要判断某个键是否存在，使用<code>IsSet</code>方法。 另外，<code>GetStringMap</code>和<code>GetStringMapString</code>直接以 map 返回某个键下面所有的键值对，前者返回<code>map[string]interface&#123;&#125;</code>，后者返回<code>map[string]string</code>。 <code>AllSettings</code>以<code>map[string]interface&#123;&#125;</code>返回所有设置。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// 省略包名和 import 部分</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  viper.SetConfigName(<span class="hljs-string">&quot;config&quot;</span>)<br>  viper.SetConfigType(<span class="hljs-string">&quot;toml&quot;</span>)<br>  viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)<br>  err := viper.ReadInConfig()<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    log.Fatal(<span class="hljs-string">&quot;read config failed: %v&quot;</span>, err)<br>  &#125;<br><br>  fmt.Println(<span class="hljs-string">&quot;protocols: &quot;</span>, viper.GetStringSlice(<span class="hljs-string">&quot;server.protocols&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;ports: &quot;</span>, viper.GetIntSlice(<span class="hljs-string">&quot;server.ports&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;timeout: &quot;</span>, viper.GetDuration(<span class="hljs-string">&quot;server.timeout&quot;</span>))<br><br>  fmt.Println(<span class="hljs-string">&quot;mysql ip: &quot;</span>, viper.GetString(<span class="hljs-string">&quot;mysql.ip&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;mysql port: &quot;</span>, viper.GetInt(<span class="hljs-string">&quot;mysql.port&quot;</span>))<br><br>  <span class="hljs-keyword">if</span> viper.IsSet(<span class="hljs-string">&quot;redis.port&quot;</span>) &#123;<br>    fmt.Println(<span class="hljs-string">&quot;redis.port is set&quot;</span>)<br>  &#125; <span class="hljs-keyword">else</span> &#123;<br>    fmt.Println(<span class="hljs-string">&quot;redis.port is not set&quot;</span>)<br>  &#125;<br><br>  fmt.Println(<span class="hljs-string">&quot;mysql settings: &quot;</span>, viper.GetStringMap(<span class="hljs-string">&quot;mysql&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;redis settings: &quot;</span>, viper.GetStringMap(<span class="hljs-string">&quot;redis&quot;</span>))<br>  fmt.Println(<span class="hljs-string">&quot;all settings: &quot;</span>, viper.AllSettings())		# 获取所有配置值<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="设置键值"><a href="#设置键值" class="headerlink" title="设置键值"></a>设置键值</h3><p>viper 支持在多个地方设置，使用下面的顺序依次读取：</p>
<ul>
<li>调用<code>Set</code>显示设置的；</li>
<li>命令行选项；</li>
<li>环境变量；</li>
<li>配置文件；</li>
<li>默认值。</li>
</ul>
<p><code>viper.Set</code></p>
<p>如果某个键通过<code>viper.Set</code>设置了值，那么这个值的优先级最高。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">viper.Set(<span class="hljs-string">&quot;redis.port&quot;</span>, <span class="hljs-number">5381</span>)<br></code></pre></td></tr></table></figure>

<p><code>命令行选项</code></p>
<p>如果一个键没有通过<code>viper.Set</code>显示设置值，那么获取时将尝试从命令行选项中读取。 如果有，优先使用。viper 使用 pflag 库来解析选项。 我们首先在<code>init</code>方法中定义选项，并且调用<code>viper.BindPFlags</code>绑定选项到配置中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>  pflag.Int(<span class="hljs-string">&quot;redis.port&quot;</span>, <span class="hljs-number">8381</span>, <span class="hljs-string">&quot;Redis port to connect&quot;</span>)<br><br>  <span class="hljs-comment">// 绑定命令行</span><br>  viper.BindPFlags(pflag.CommandLine)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后，在<code>main</code>方法开头处调用<code>pflag.Parse</code>解析选项。</p>
<p>编译、运行程序：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs sh">$ ./main.exe --redis.port 9381<br>awesome web<br>DEBUG<br>mysql ip:  127.0.0.1<br>mysql port:  3306<br>mysql user:  dj<br>mysql password:  123456<br>mysql database:  awesome<br>redis ip:  127.0.0.1<br>redis port:  9381<br></code></pre></td></tr></table></figure>

<p><code>环境变量</code></p>
<p>如果前面都没有获取到键值，将尝试从环境变量中读取。我们既可以一个个绑定，也可以自动全部绑定。</p>
<p>在<code>init</code>方法中调用<code>AutomaticEnv</code>方法绑定全部环境变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// 绑定环境变量</span><br>  viper.AutomaticEnv()<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为了验证是否绑定成功，我们在<code>main</code>方法中将环境变量 GOPATH 打印出来：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// 省略部分代码</span><br><br>  fmt.Println(<span class="hljs-string">&quot;GOPATH: &quot;</span>, viper.Get(<span class="hljs-string">&quot;GOPATH&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>也可以单独绑定环境变量：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">init</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// 绑定环境变量</span><br>  viper.BindEnv(<span class="hljs-string">&quot;redis.port&quot;</span>)<br>  viper.BindEnv(<span class="hljs-string">&quot;go.path&quot;</span>, <span class="hljs-string">&quot;GOPATH&quot;</span>)<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-comment">// 省略部分代码</span><br>  fmt.Println(<span class="hljs-string">&quot;go path: &quot;</span>, viper.Get(<span class="hljs-string">&quot;go.path&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>调用<code>BindEnv</code>方法，如果只传入一个参数，则这个参数既表示键名，又表示环境变量名。 如果传入两个参数，则第一个参数表示键名，第二个参数表示环境变量名。</p>
<p>还可以通过<code>viper.SetEnvPrefix</code>方法设置环境变量前缀，这样一来，通过<code>AutomaticEnv</code>和一个参数的<code>BindEnv</code>绑定的环境变量， 在使用<code>Get</code>的时候，viper 会自动加上这个前缀再从环境变量中查找。</p>
<p>如果对应的环境变量不存在，viper 会自动将键名全部转为大写再查找一次。所以，使用键名<code>gopath</code>也能读取环境变量<code>GOPATH</code>的值。</p>
<h3 id="读取配置"><a href="#读取配置" class="headerlink" title="读取配置"></a>读取配置</h3><p>从<code>io.Reader</code>中读取</p>
<p>viper 支持从<code>io.Reader</code>中读取配置。这种形式很灵活，来源可以是文件，也可以是程序中生成的字符串，甚至可以从网络连接中读取的字节流。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;bytes&quot;</span><br>  <span class="hljs-string">&quot;fmt&quot;</span><br>  <span class="hljs-string">&quot;log&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  viper.SetConfigType(<span class="hljs-string">&quot;toml&quot;</span>)<br>  tomlConfig := []<span class="hljs-type">byte</span>(<span class="hljs-string">`</span><br><span class="hljs-string">app_name = &quot;awesome web&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string"># possible values: DEBUG, INFO, WARNING, ERROR, FATAL</span><br><span class="hljs-string">log_level = &quot;DEBUG&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[mysql]</span><br><span class="hljs-string">ip = &quot;127.0.0.1&quot;</span><br><span class="hljs-string">port = 3306</span><br><span class="hljs-string">user = &quot;dj&quot;</span><br><span class="hljs-string">password = 123456</span><br><span class="hljs-string">database = &quot;awesome&quot;</span><br><span class="hljs-string"></span><br><span class="hljs-string">[redis]</span><br><span class="hljs-string">ip = &quot;127.0.0.1&quot;</span><br><span class="hljs-string">port = 7381</span><br><span class="hljs-string">`</span>)<br>  err := viper.ReadConfig(bytes.NewBuffer(tomlConfig))<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    log.Fatal(<span class="hljs-string">&quot;read config failed: %v&quot;</span>, err)<br>  &#125;<br><br>  fmt.Println(<span class="hljs-string">&quot;redis port: &quot;</span>, viper.GetInt(<span class="hljs-string">&quot;redis.port&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>Unmarshal</code></p>
<p>viper 支持将配置<code>Unmarshal</code>到一个结构体中，为结构体中的对应字段赋值。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br>  <span class="hljs-string">&quot;log&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br>)<br><br><span class="hljs-keyword">type</span> Config <span class="hljs-keyword">struct</span> &#123;<br>  AppName  <span class="hljs-type">string</span><br>  LogLevel <span class="hljs-type">string</span><br><br>  MySQL    MySQLConfig<br>  Redis    RedisConfig<br>&#125;<br><br><span class="hljs-keyword">type</span> MySQLConfig <span class="hljs-keyword">struct</span> &#123;<br>  IP       <span class="hljs-type">string</span><br>  Port     <span class="hljs-type">int</span><br>  User     <span class="hljs-type">string</span><br>  Password <span class="hljs-type">string</span><br>  Database <span class="hljs-type">string</span><br>&#125;<br><br><span class="hljs-keyword">type</span> RedisConfig <span class="hljs-keyword">struct</span> &#123;<br>  IP   <span class="hljs-type">string</span><br>  Port <span class="hljs-type">int</span><br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  viper.SetConfigName(<span class="hljs-string">&quot;config&quot;</span>)<br>  viper.SetConfigType(<span class="hljs-string">&quot;toml&quot;</span>)<br>  viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)<br>  err := viper.ReadInConfig()<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    log.Fatal(<span class="hljs-string">&quot;read config failed: %v&quot;</span>, err)<br>  &#125;<br><br>  <span class="hljs-keyword">var</span> c Config<br>  viper.Unmarshal(&amp;c)<br><br>  fmt.Println(c.MySQL)<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="保存配置"><a href="#保存配置" class="headerlink" title="保存配置"></a>保存配置</h3><p>有时候，我们想要将程序中生成的配置，或者所做的修改保存下来。viper 提供了接口！</p>
<ul>
<li><code>WriteConfig</code>：将当前的 viper 配置写到预定义路径，如果没有预定义路径，返回错误。将会覆盖当前配置；</li>
<li><code>SafeWriteConfig</code>：与上面功能一样，但是如果配置文件存在，则不覆盖；</li>
<li><code>WriteConfigAs</code>：保存配置到指定路径，如果文件存在，则覆盖；</li>
<li><code>SafeWriteConfigAs</code>：与上面功能一样，但是入股配置文件存在，则不覆盖。</li>
</ul>
<p>下面我们通过程序生成一个<code>config.toml</code>配置：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;log&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  viper.SetConfigName(<span class="hljs-string">&quot;config&quot;</span>)<br>  viper.SetConfigType(<span class="hljs-string">&quot;toml&quot;</span>)<br>  viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)<br><br>  viper.Set(<span class="hljs-string">&quot;app_name&quot;</span>, <span class="hljs-string">&quot;awesome web&quot;</span>)<br>  viper.Set(<span class="hljs-string">&quot;log_level&quot;</span>, <span class="hljs-string">&quot;DEBUG&quot;</span>)<br>  viper.Set(<span class="hljs-string">&quot;mysql.ip&quot;</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>)<br>  viper.Set(<span class="hljs-string">&quot;mysql.port&quot;</span>, <span class="hljs-number">3306</span>)<br>  viper.Set(<span class="hljs-string">&quot;mysql.user&quot;</span>, <span class="hljs-string">&quot;root&quot;</span>)<br>  viper.Set(<span class="hljs-string">&quot;mysql.password&quot;</span>, <span class="hljs-string">&quot;123456&quot;</span>)<br>  viper.Set(<span class="hljs-string">&quot;mysql.database&quot;</span>, <span class="hljs-string">&quot;awesome&quot;</span>)<br><br>  viper.Set(<span class="hljs-string">&quot;redis.ip&quot;</span>, <span class="hljs-string">&quot;127.0.0.1&quot;</span>)<br>  viper.Set(<span class="hljs-string">&quot;redis.port&quot;</span>, <span class="hljs-number">6381</span>)<br><br>  err := viper.SafeWriteConfig()<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    log.Fatal(<span class="hljs-string">&quot;write config failed: &quot;</span>, err)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="监听文件修改"><a href="#监听文件修改" class="headerlink" title="监听文件修改"></a>监听文件修改</h3><p>viper 可以监听文件修改，热加载配置。因此不需要重启服务器，就能让配置生效。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br>  <span class="hljs-string">&quot;log&quot;</span><br>  <span class="hljs-string">&quot;time&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/spf13/viper&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  viper.SetConfigName(<span class="hljs-string">&quot;config&quot;</span>)<br>  viper.SetConfigType(<span class="hljs-string">&quot;toml&quot;</span>)<br>  viper.AddConfigPath(<span class="hljs-string">&quot;.&quot;</span>)<br>  err := viper.ReadInConfig()<br>  <span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> &#123;<br>    log.Fatal(<span class="hljs-string">&quot;read config failed: %v&quot;</span>, err)<br>  &#125;<br><br>  viper.WatchConfig()<br><br>  fmt.Println(<span class="hljs-string">&quot;redis port before sleep: &quot;</span>, viper.Get(<span class="hljs-string">&quot;redis.port&quot;</span>))<br>  time.Sleep(time.Second * <span class="hljs-number">10</span>)<br>  fmt.Println(<span class="hljs-string">&quot;redis port after sleep: &quot;</span>, viper.Get(<span class="hljs-string">&quot;redis.port&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>



<p>只需要调用<code>viper.WatchConfig</code>，viper 会自动监听配置修改。如果有修改，重新加载的配置。</p>
<p>上面程序中，我们先打印<code>redis.port</code>的值，然后<code>Sleep</code> 10s。在这期间修改配置中<code>redis.port</code>的值，<code>Sleep</code>结束后再次打印。 发现打印出修改后的值：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">redis port before sleep:  <span class="hljs-number">7381</span><br>redis port after sleep:  <span class="hljs-number">73810</span><br></code></pre></td></tr></table></figure>

<p>另外，还可以为配置修改增加一个回调：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs go">viper.OnConfigChange(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(e fsnotify.Event)</span></span> &#123;<br>  fmt.Printf(<span class="hljs-string">&quot;Config file:%s Op:%s\n&quot;</span>, e.Name, e.Op)<br>&#125;)<br></code></pre></td></tr></table></figure>

<p>这样文件修改时会执行这个回调。</p>
<p>viper 使用<a href="https://link.juejin.cn/?target=https://github.com/fsnotify/fsnotify">fsnotify</a>这个库来实现监听文件修改的功能。</p>
<h3 id="viper之坑"><a href="#viper之坑" class="headerlink" title="viper之坑"></a>viper之坑</h3><ul>
<li>yaml空值，修改完成之后会丢失</li>
<li>key全部自动转成小写，docker-compose里面容器大小写敏感</li>
</ul>
<h2 id="golang-set包"><a href="#golang-set包" class="headerlink" title="golang-set包"></a>golang-set包</h2><p>Set是一种基本的数据结构,它具备确定性、互异性、无序性三个特点。因此，在开发过程中我们通常用它来判断一些数据的集合与另一个数据集合或者元素的包含关系。在大部分开发语言中set都是一种基本的数据结构，但是golang不提供set类型。通常情况下，我们都会用map[interface{}]struct{}{}来代替set实现包含关系的判断。但事实上，我们在github上会发现一些第三方的开源包。例如<a target="_blank" rel="noopener" href="https://links.jianshu.com/go?to=https://github.com/deckarep/golang-set">golang-set</a>就是一个相对成熟的包。截止到2021年3月份已经有1.8k的star和160+的fork。同时这个包本身也已经应用于docker项目中。是一个可用性和可靠性都经过验证的第三方包，可以放心使用</p>
<p>golang-set包本身也是基于map[interface{}]struct{}{}结构实现的，同时golang-set包提供了线程安全和不保证安全的两种set类型，相比于线程安全的set对象，不保证安全的set对象执行效率会更高一点。</p>
<h3 id="快速使用-3"><a href="#快速使用-3" class="headerlink" title="快速使用"></a>快速使用</h3><p>golang-set的使用也非常简单，只需导入该包然后创建set对象即可开始使用。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">import</span> mapset <span class="hljs-string">&quot;github.com/deckarep/golang-set&quot;</span><br><br>set := mapset.NewSet(<span class="hljs-number">1</span>, <span class="hljs-number">2</span>, <span class="hljs-number">3</span>, <span class="hljs-number">4</span>)<br>set.Add(<span class="hljs-number">6</span>)<br><br>set.Contains(<span class="hljs-number">5</span>)<br>set.Remove(<span class="hljs-number">1</span>)<br></code></pre></td></tr></table></figure>

<h3 id="set类型"><a href="#set类型" class="headerlink" title="set类型"></a>set类型</h3><p>golang 提供了两种set类型，一种是普通的集合对象，一种是线程安全的集合对象，通过结构嵌套的方式为普通集合对象新增了一个全局锁，实现了线程安全。具体如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> threadSafeSet <span class="hljs-keyword">struct</span> &#123;<br>    s threadUnsafeSet<br>    sync.RWMutex<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newThreadSafeSet</span><span class="hljs-params">()</span></span> threadSafeSet &#123;<br>    <span class="hljs-keyword">return</span> threadSafeSet&#123;s: newThreadUnsafeSet()&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="操作方法"><a href="#操作方法" class="headerlink" title="操作方法"></a>操作方法</h3><p>golang-set包提供的集合操作方法包含如下23个方法：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">type</span> Set <span class="hljs-keyword">interface</span> &#123;<br>    Add(i <span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">bool</span><br>    Cardinality() <span class="hljs-type">int</span><br>    Clear()<br>    Clone() Set<br>    Contains(i ...<span class="hljs-keyword">interface</span>&#123;&#125;) <span class="hljs-type">bool</span><br>    Difference(other Set) Set<br>    Equal(other Set) <span class="hljs-type">bool</span><br>    Intersect(other Set) Set<br>    IsProperSubset(other Set) <span class="hljs-type">bool</span><br>    IsProperSuperset(other Set) <span class="hljs-type">bool</span><br>    IsSubset(other Set) <span class="hljs-type">bool</span><br>    IsSuperset(other Set) <span class="hljs-type">bool</span><br>    Each(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(<span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">bool</span>)<br>    Iter() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;<br>    Iterator() *Iterator<br>    Remove(i <span class="hljs-keyword">interface</span>&#123;&#125;)<br>    String() <span class="hljs-type">string</span><br>    SymmetricDifference(other Set) Set<br>    Union(other Set) Set<br>    Pop() <span class="hljs-keyword">interface</span>&#123;&#125;<br>    PowerSet() Set<br>    CartesianProduct(other Set) Set<br>    ToSlice() []<span class="hljs-keyword">interface</span>&#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>具体含义如下：</p>
<ul>
<li><p>Add(i interface{}) bool:用于向集合中添加某些元素</p>
</li>
<li><p>Cardinality() int ：返回集合元素个数</p>
</li>
<li><p>Clear() ：清空集合中全部元素，剩下一个空的集合，使用不需要通过NewSet进行初始化</p>
</li>
<li><p>Clone() Set ：复制一个一模一样的集合对象</p>
</li>
<li><p>Contains(i …interface{}) bool ：返回是否参数元素全部包含于集合中</p>
</li>
<li><p>Difference(other Set) Set ：将返回当前集合与参数集合的全部差异元素，这些元素包含于本集合但是不包含于参数集合。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>Equal(other Set) bool ：如果参数集合与当前集合的容量和全部元素是相同的，那么会被然认为是相同的，无需考虑元素的顺序。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>Intersect(other Set) Set：将返回两个集合的交集。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>IsProperSubset(other Set) bool：判断当前set是否为参数set的真子集（包含但不相等）。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>IsProperSuperset(other Set) bool：判断参数set是否为当前set的真子集（包含但不相等）。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>IsSubset(other Set) bool：判断当前set是否为参数set的子集（包含，允许相等）。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>IsSuperset(other Set) bool：判断参数set是否为当前set的子集（包含，允许相等）。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>Each(func(interface{}) bool)：遍历元素，并对每个元素执行传递的func。如果传递的func返回true，则此时停止迭代。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">//clone a</span><br>b := NewSet()<br>a.Each(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(elem <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> <span class="hljs-type">bool</span> &#123;<br>    b.Add(elem)<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span><br>&#125;)<br></code></pre></td></tr></table></figure>
</li>
<li><p>Iter() &lt;-chan interface{}：返回一个可以遍历set的channel</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">b := NewSet()<br><span class="hljs-keyword">for</span> val := <span class="hljs-keyword">range</span> a.Iter() &#123;<br>    b.Add(val)<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Iterator() *Iterator：返回一个Iterator对象，用于遍历set的全部参数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go">b := NewThreadUnsafeSet()<br><span class="hljs-keyword">for</span> val := <span class="hljs-keyword">range</span> a.Iterator().C &#123;<br>    b.Add(val)<br>&#125;<br></code></pre></td></tr></table></figure>
</li>
<li><p>Remove(i interface{}) :从当前集合中移除某个元素</p>
</li>
<li><p>String() string：返回集合的string格式，set:{}用于查看该集合</p>
</li>
<li><p>SymmetricDifference(other Set) Set：返回当前集合与参数集合的对称差集（对称差集中的元素要么包含于本集合，要么包含于参数集合，但是不能属于两者的交集）。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>Union(other Set) Set：返回当前集合与参数集合的并集。注意：入参的set类型与方法接受者set的类型必须一致，否则将导致panic。</p>
</li>
<li><p>Pop() interface{}：移除并返回一个随机的元素</p>
</li>
<li><p>PowerSet() Set：返回当前集合的全部子集</p>
</li>
<li><p>CartesianProduct(other Set) Set：返回当前集合与参数集合的笛卡尔积结果集合</p>
</li>
<li><p>ToSlice() []interface{}：返回当前集合的切片对象。</p>
</li>
</ul>
<h3 id="源码解析"><a href="#源码解析" class="headerlink" title="源码解析"></a>源码解析</h3><p>由上文可知，golang-set提供了普通和线程安全两种类型的集合对象。其中线程安全的集合对象，通过结构嵌套的方式为普通集合对象新增了一个全局锁，实现了线程安全。因此针对方法的实现主要通过普通集合对象的实现来介绍。</p>
<p>golang-set包的具体实现其实非常简单，基于golang-set原生的map结构作为基本的存储结构，value以一个不占用内存空间的struct{}{}为值。其中一个我认为值得我们借鉴的开发技巧就是golang-set的遍历方法，具体源码如下所示：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(set *threadUnsafeSet)</span></span> Iter() &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125; &#123;<br>    ch := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>        <span class="hljs-keyword">for</span> elem := <span class="hljs-keyword">range</span> *set &#123;<br>            ch &lt;- elem<br>        &#125;<br>        <span class="hljs-built_in">close</span>(ch)<br>    &#125;()<br><br>    <span class="hljs-keyword">return</span> ch<br>&#125;<br></code></pre></td></tr></table></figure>

<p>它通过创建一个协程去遍历set对象，同时返回一个channel 由用户去读取set的遍历结果，是的读取较大set对象时，用户无需等待，而直接读取，具有较高的效率，但是他的缺点也十分明显，那就是这个方式无法中途退出，也就是说，在使用该方法遍历时，用户必须保证会执行完全部的遍历结果。否则，由于返回的channel是无缓冲的channel,用户不读取时，Iterator()方法中的遍历协程将阻塞，而无法退出，就会发生内存泄漏，</p>
<p>为了方便遍历方法的中途退出，golang-set又提供了另外一个遍历方法，通过返回一个美枚举对象来实现set对象的异步遍历。具体源码如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs golang"><span class="hljs-keyword">type</span> Iterator <span class="hljs-keyword">struct</span> &#123;<br>    C    &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;<br>    stop <span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;<br>&#125;<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">newIterator</span><span class="hljs-params">()</span></span> (*Iterator, <span class="hljs-keyword">chan</span>&lt;- <span class="hljs-keyword">interface</span>&#123;&#125;, &lt;-<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;) &#123;<br>    itemChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">interface</span>&#123;&#125;)<br>    stopChan := <span class="hljs-built_in">make</span>(<span class="hljs-keyword">chan</span> <span class="hljs-keyword">struct</span>&#123;&#125;)<br>    <span class="hljs-keyword">return</span> &amp;Iterator&#123;<br>        C:    itemChan,<br>        stop: stopChan,<br>    &#125;, itemChan, stopChan<br>&#125;<br><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-params">(set *threadUnsafeSet)</span></span> Iterator() *Iterator &#123;<br>    iterator, ch, stopCh := newIterator()<br><br>    <span class="hljs-keyword">go</span> <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>    L:<br>        <span class="hljs-keyword">for</span> elem := <span class="hljs-keyword">range</span> *set &#123;<br>            <span class="hljs-keyword">select</span> &#123;<br>            <span class="hljs-keyword">case</span> &lt;-stopCh:<br>                <span class="hljs-keyword">break</span> L<br>            <span class="hljs-keyword">case</span> ch &lt;- elem:<br>            &#125;<br>        &#125;<br>        <span class="hljs-built_in">close</span>(ch)<br>    &#125;()<br><br>    <span class="hljs-keyword">return</span> iterator<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其中枚举对象Iterator中的C channel用于异步读取遍历结果，stop channel用于主动停止遍历协程，从而避免内存泄漏。具体的使用方法如下：</p>
<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs golang">it := a.Iterator()<br><br><span class="hljs-keyword">for</span> v := <span class="hljs-keyword">range</span> it.C &#123;<br>    <span class="hljs-comment">//退出条件</span><br>    <span class="hljs-keyword">if</span> (v == <span class="hljs-number">10</span>)&#123;<br>        it.stop()<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h2 id="gopsutil"><a href="#gopsutil" class="headerlink" title="gopsutil"></a>gopsutil</h2><p>gopsutil是psutil的go语言版本实现，主要功能是获取系统上各项监控信息，包括不限于cpu,内存，磁盘，网络，进程，docker等等</p>
<p>gopsutil支持跨平台多架构，包括i386&#x2F;amd64&#x2F;arm架构，以及windows,linux等各种系统，其中对linux的支持项最多</p>
<p>gopsutil最新为v3版本，默认是v2版本</p>
<h3 id="快速使用-4"><a href="#快速使用-4" class="headerlink" title="快速使用"></a>快速使用</h3><p>安装</p>
<figure class="highlight vim"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs vim"><span class="hljs-keyword">go</span> <span class="hljs-built_in">get</span> github.<span class="hljs-keyword">com</span>/shirou/gopsutil<br></code></pre></td></tr></table></figure>

<p>由于<code>gopsutil</code>库用到了<code>golang.org/x/sys</code>，后者在墙外，如果有类似下面的报错：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">cannot find <span class="hljs-keyword">package</span> <span class="hljs-string">&quot;golang.org/x/sys/windows&quot;</span><br></code></pre></td></tr></table></figure>

<p>可使用下面的命令下载<code>golang.org/x/sys</code>在 GitHub 上的镜像：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">git <span class="hljs-built_in">clone</span> git@github.com:golang/sys.git <span class="hljs-variable">$GOPATH</span>/src/golang.org/x/sys<br></code></pre></td></tr></table></figure>

<p>使用</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>  <span class="hljs-string">&quot;fmt&quot;</span><br><br>  <span class="hljs-string">&quot;github.com/shirou/gopsutil/mem&quot;</span><br>)<br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  v, _ := mem.VirtualMemory()<br><br>  fmt.Printf(<span class="hljs-string">&quot;Total: %v, Available: %v, UsedPercent:%f%%\n&quot;</span>, v.Total, v.Available, v.UsedPercent)<br><br>  fmt.Println(v)<br>&#125;<br></code></pre></td></tr></table></figure>

<p><code>gopsutil</code>将不同的功能划分到不同的子包中：</p>
<ul>
<li><code>cpu</code>：CPU 相关；</li>
<li><code>disk</code>：磁盘相关；</li>
<li><code>docker</code>：docker 相关；</li>
<li><code>host</code>：主机相关；</li>
<li><code>mem</code>：内存相关；</li>
<li><code>net</code>：网络相关；</li>
<li><code>process</code>：进程相关；</li>
<li><code>winservices</code>：Windows 服务相关。</li>
</ul>
<p>想要使用对应的功能，要导入对应的子包。例如，上面代码中，我们要获取内存信息，导入的是<code>mem</code>子包。<code>mem.VirtualMemory()</code>方法返回内存信息结构<code>mem.VirtualMemoryStat</code>，该结构有丰富的字段，我们最常使用的无外乎<code>Total</code>（总内存）、<code>Available</code>（可用内存）、<code>Used</code>（已使用内存）和<code>UsedPercent</code>（内存使用百分比）。<code>mem.VirtualMemoryStat</code>还实现了<code>fmt.Stringer</code>接口，以 JSON 格式返回内存信息。语句<code>fmt.Println(v)</code>会自动调用<code>v.String()</code>，将返回信息输出。程序输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">Total: <span class="hljs-number">31252709376</span>, Available: <span class="hljs-number">18457317376</span>, UsedPercent:<span class="hljs-number">36.622837</span>%<br>&#123;<span class="hljs-string">&quot;total&quot;</span>:<span class="hljs-number">31252709376</span>,<span class="hljs-string">&quot;available&quot;</span>:<span class="hljs-number">18457317376</span>,<span class="hljs-string">&quot;used&quot;</span>:<span class="hljs-number">11445628928</span>,<span class="hljs-string">&quot;usedPercent&quot;</span>:<span class="hljs-number">36.62283736842822</span>,<span class="hljs-string">&quot;free&quot;</span>:<span class="hljs-number">3926921216</span>,<span class="hljs-string">&quot;active&quot;</span>:<span class="hljs-number">16073904128</span>,<span class="hljs-string">&quot;inactive&quot;</span>:<span class="hljs-number">9631600640</span>,<span class="hljs-string">&quot;wired&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;laundry&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;buffers&quot;</span>:<span class="hljs-number">991232000</span>,<span class="hljs-string">&quot;cached&quot;</span>:<span class="hljs-number">14888927232</span>,<span class="hljs-string">&quot;writeback&quot;</span>:<span class="hljs-number">4096</span>,<span class="hljs-string">&quot;dirty&quot;</span>:<span class="hljs-number">66256896</span>,<span class="hljs-string">&quot;writebacktmp&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;shared&quot;</span>:<span class="hljs-number">891125760</span>,<span class="hljs-string">&quot;slab&quot;</span>:<span class="hljs-number">1062789120</span>,<span class="hljs-string">&quot;sreclaimable&quot;</span>:<span class="hljs-number">760090624</span>,<span class="hljs-string">&quot;sunreclaim&quot;</span>:<span class="hljs-number">302698496</span>,<span class="hljs-string">&quot;pagetables&quot;</span>:<span class="hljs-number">108027904</span>,<span class="hljs-string">&quot;swapcached&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;commitlimit&quot;</span>:<span class="hljs-number">47626792960</span>,<span class="hljs-string">&quot;committedas&quot;</span>:<span class="hljs-number">38288269312</span>,<span class="hljs-string">&quot;hightotal&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;highfree&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;lowtotal&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;lowfree&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;swaptotal&quot;</span>:<span class="hljs-number">32000438272</span>,<span class="hljs-string">&quot;swapfree&quot;</span>:<span class="hljs-number">32000438272</span>,<span class="hljs-string">&quot;mapped&quot;</span>:<span class="hljs-number">3175104512</span>,<span class="hljs-string">&quot;vmalloctotal&quot;</span>:<span class="hljs-number">35184372087808</span>,<span class="hljs-string">&quot;vmallocused&quot;</span>:<span class="hljs-number">100999168</span>,<span class="hljs-string">&quot;vmallocchunk&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;hugepagestotal&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;hugepagesfree&quot;</span>:<span class="hljs-number">0</span>,<span class="hljs-string">&quot;hugepagesize&quot;</span>:<span class="hljs-number">2097152</span>&#125;<br></code></pre></td></tr></table></figure>

<p>单位为字节，我的电脑内存 32GB，当前使用百分比为 36%，可用内存 18457317376（即 18GB）。</p>
<h3 id="CPU"><a href="#CPU" class="headerlink" title="CPU"></a>CPU</h3><p>我们知道 CPU 的核数有两种，一种是物理核数，一种是逻辑核数。物理核数就是主板上实际有多少个 CPU，一个物理 CPU 上可以有多个核心，这些核心被称为逻辑核。<code>gopsutil</code>中 CPU 相关功能在<code>cpu</code>子包中，<code>cpu</code>子包提供了获取物理和逻辑核数、CPU 使用率的接口：</p>
<p><code>Counts(logical bool)</code>：传入<code>false</code>，返回物理核数，传入<code>true</code>，返回逻辑核数；</p>
<p><code>Percent(interval time.Duration, percpu bool)</code>：表示获取<code>interval</code>时间间隔内的 CPU 使用率，<code>percpu</code>为<code>false</code>时，获取总的 CPU 使用率，<code>percpu</code>为<code>true</code>时，分别获取每个 CPU 的使用率，返回一个<code>[]float64</code>类型的值。</p>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  physicalCnt, _ := cpu.Counts(<span class="hljs-literal">false</span>)<br>  logicalCnt, _ := cpu.Counts(<span class="hljs-literal">true</span>)<br>  fmt.Printf(<span class="hljs-string">&quot;physical count:%d logical count:%d\n&quot;</span>, physicalCnt, logicalCnt)<br><br>  totalPercent, _ := cpu.Percent(<span class="hljs-number">3</span>*time.Second, <span class="hljs-literal">false</span>)<br>  perPercents, _ := cpu.Percent(<span class="hljs-number">3</span>*time.Second, <span class="hljs-literal">true</span>)<br>  fmt.Printf(<span class="hljs-string">&quot;total percent:%v per percents:%v&quot;</span>, totalPercent, perPercents)<br>&#125;<br><br></code></pre></td></tr></table></figure>



<p>上面代码获取物理核数和逻辑核数，并获取 3s 内的总 CPU 使用率和每个 CPU 各自的使用率，程序输出（注意每次运行输出可能都不相同）：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">physical count:<span class="hljs-number">8</span> logical count:<span class="hljs-number">16</span><br>total percent:[<span class="hljs-number">8.362730856991261</span>] per percents:[<span class="hljs-number">12.012987012975508</span> <span class="hljs-number">8.524590163938532</span> <span class="hljs-number">11.038961038943015</span> <span class="hljs-number">6.249999999988781</span> <span class="hljs-number">8.47457627121518</span> <span class="hljs-number">5.050505050493915</span> <span class="hljs-number">8.813559322011011</span> <span class="hljs-number">4.745762711875798</span> <span class="hljs-number">5.479452054789401</span> <span class="hljs-number">9.427609427602931</span> <span class="hljs-number">6.802721088430114</span> <span class="hljs-number">6.020066889640449</span> <span class="hljs-number">9.897610921502555</span> <span class="hljs-number">3.7542662116080683</span> <span class="hljs-number">8.135593220332085</span> <span class="hljs-number">5.4054054054020835</span>]<br></code></pre></td></tr></table></figure>

<p><strong>详细信息</strong></p>
<p>调用<code>cpu.Info()</code>可获取 CPU 的详细信息，返回<code>[]cpu.InfoStat</code>：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  infos, _ := cpu.Info()<br>  <span class="hljs-keyword">for</span> _, info := <span class="hljs-keyword">range</span> infos &#123;<br>    data, _ := json.MarshalIndent(info, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot; &quot;</span>)<br>    fmt.Print(<span class="hljs-type">string</span>(data))<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>为了方便查看，我使用 JSON 输出结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs json"><span class="hljs-punctuation">&#123;</span><br> <span class="hljs-attr">&quot;cpu&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;vendorId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;GenuineIntel&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;family&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;198&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;model&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;stepping&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;physicalId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;BFEBFBFF000906E9&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;coreId&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;cores&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">8</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;modelName&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;Intel(R) Core(TM) i7-7700 CPU @ 3.60GHz&quot;</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;mhz&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">3601</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;cacheSize&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-number">0</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;flags&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-punctuation">[</span><span class="hljs-punctuation">]</span><span class="hljs-punctuation">,</span><br> <span class="hljs-attr">&quot;microcode&quot;</span><span class="hljs-punctuation">:</span> <span class="hljs-string">&quot;&quot;</span><br><span class="hljs-punctuation">&#125;</span><br></code></pre></td></tr></table></figure>

<p>由结果可以看出，CPU 是 Intel 的 i7-7700 系列，频率 3.60GHz。上面是我在 Windows 上运行的返回结果，内部使用了<code>github.com/StackExchange/wmi</code>库。在 Linux 下每个逻辑 CPU 都会返回一个<code>InfoStat</code>结构。</p>
<p><strong>时间占用</strong></p>
<p>调用<code>cpu.Times(percpu bool)</code>可以获取从开机算起，总 CPU 和 每个单独的 CPU 时间占用情况。传入<code>percpu=false</code>返回总的，传入<code>percpu=true</code>返回单个的。每个 CPU 时间占用情况是一个<code>TimeStat</code>结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// src/github.com/shirou/gopsutil/cpu/cpu.go</span><br><span class="hljs-keyword">type</span> TimesStat <span class="hljs-keyword">struct</span> &#123;<br>  CPU       <span class="hljs-type">string</span>  <span class="hljs-string">`json:&quot;cpu&quot;`</span><br>  User      <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;user&quot;`</span><br>  System    <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;system&quot;`</span><br>  Idle      <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;idle&quot;`</span><br>  Nice      <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;nice&quot;`</span><br>  Iowait    <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;iowait&quot;`</span><br>  Irq       <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;irq&quot;`</span><br>  Softirq   <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;softirq&quot;`</span><br>  Steal     <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;steal&quot;`</span><br>  Guest     <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;guest&quot;`</span><br>  GuestNice <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;guestNice&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>CPU</code>：CPU 标识，如果是总的，该字段为<code>cpu-total</code>，否则为<code>cpu0</code>、<code>cpu1</code>…；</li>
<li><code>User</code>：用户时间占用（用户态）；</li>
<li><code>System</code>：系统时间占用（内核态）；</li>
<li><code>Idle</code>：空闲时间；</li>
<li>…</li>
</ul>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  infos, _ := cpu.Times(<span class="hljs-literal">true</span>)<br>  <span class="hljs-keyword">for</span> _, info := <span class="hljs-keyword">range</span> infos &#123;<br>    data, _ := json.MarshalIndent(info, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot; &quot;</span>)<br>    fmt.Print(<span class="hljs-type">string</span>(data))<br>  &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>为了方便查看，我用 JSON 输出结果，下面是其中一个输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go">&#123;<br> <span class="hljs-string">&quot;cpu&quot;</span>: <span class="hljs-string">&quot;cpu0&quot;</span>,<br> <span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-number">674.46875</span>,<br> <span class="hljs-string">&quot;system&quot;</span>: <span class="hljs-number">1184.984375</span>,<br> <span class="hljs-string">&quot;idle&quot;</span>: <span class="hljs-number">7497.1875</span>,<br> <span class="hljs-string">&quot;nice&quot;</span>: <span class="hljs-number">0</span>,<br> <span class="hljs-string">&quot;iowait&quot;</span>: <span class="hljs-number">0</span>,<br> <span class="hljs-string">&quot;irq&quot;</span>: <span class="hljs-number">75.578125</span>,<br> <span class="hljs-string">&quot;softirq&quot;</span>: <span class="hljs-number">0</span>,<br> <span class="hljs-string">&quot;steal&quot;</span>: <span class="hljs-number">0</span>,<br> <span class="hljs-string">&quot;guest&quot;</span>: <span class="hljs-number">0</span>,<br> <span class="hljs-string">&quot;guestNice&quot;</span>: <span class="hljs-number">0</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="磁盘"><a href="#磁盘" class="headerlink" title="磁盘"></a>磁盘</h3><p>子包<code>disk</code>用于获取磁盘信息。<code>disk</code>可获取 IO 统计、分区和使用率信息。下面依次介绍。</p>
<p><strong>IO 统计</strong></p>
<p>调用<code>disk.IOCounters()</code>函数，返回的 IO 统计信息用<code>map[string]IOCountersStat</code>类型表示。每个分区一个结构，键为分区名，值为统计信息。这里摘取统计结构的部分字段，主要有读写的次数、字节数和时间：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// src/github.com/shirou/gopsutil/disk/disk.go</span><br><span class="hljs-keyword">type</span> IOCountersStat <span class="hljs-keyword">struct</span> &#123;<br>  ReadCount        <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;readCount&quot;`</span><br>  MergedReadCount  <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;mergedReadCount&quot;`</span><br>  WriteCount       <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;writeCount&quot;`</span><br>  MergedWriteCount <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;mergedWriteCount&quot;`</span><br>  ReadBytes        <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;readBytes&quot;`</span><br>  WriteBytes       <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;writeBytes&quot;`</span><br>  ReadTime         <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;readTime&quot;`</span><br>  WriteTime        <span class="hljs-type">uint64</span> <span class="hljs-string">`json:&quot;writeTime&quot;`</span><br>  <span class="hljs-comment">// ...</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  mapStat, _ := disk.IOCounters()<br>  <span class="hljs-keyword">for</span> name, stat := <span class="hljs-keyword">range</span> mapStat &#123;<br>    fmt.Println(name)<br>    data, _ := json.MarshalIndent(stat, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br>    fmt.Println(<span class="hljs-type">string</span>(data))<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出包括所有分区，我这里只展示一个：</p>
<figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs gcode"><span class="hljs-symbol">nvme0</span><span class="hljs-symbol">n1</span>p<span class="hljs-number">3</span><br>&#123;<br>  <span class="hljs-string">&quot;readCount&quot;</span>: <span class="hljs-number">48</span>,<br>  <span class="hljs-string">&quot;mergedReadCount&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;writeCount&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;mergedWriteCount&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;readBytes&quot;</span>: <span class="hljs-number">598016</span>,<br>  <span class="hljs-string">&quot;writeBytes&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;readTime&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;writeTime&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;iopsInProgress&quot;</span>: <span class="hljs-number">0</span>,<br>  <span class="hljs-string">&quot;ioTime&quot;</span>: <span class="hljs-number">12</span>,<br>  <span class="hljs-string">&quot;weightedIO&quot;</span>: <span class="hljs-number">1</span>,<br>  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;nvme0n1p3&quot;</span>,<br>  <span class="hljs-string">&quot;serialNumber&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,<br>  <span class="hljs-string">&quot;label&quot;</span>: <span class="hljs-string">&quot;&quot;</span><br>&#125;<br><br><br></code></pre></td></tr></table></figure>

<p>注意，<code>disk.IOCounters()</code>可传入可变数量的字符串参数用于标识分区，<strong>此参数在 Windows 上无效</strong>。</p>
<p><strong>分区</strong></p>
<p>调用<code>disk.PartitionStat(all bool)</code>函数，返回分区信息。如果<code>all = false</code>，只返回实际的物理分区（包括硬盘、CD-ROM、USB），忽略其它的虚拟分区。如果<code>all = true</code>则返回所有的分区。返回类型为<code>[]PartitionStat</code>，每个分区对应一个<code>PartitionStat</code>结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// src/github.com/shirou/gopsutil/disk/</span><br><span class="hljs-keyword">type</span> PartitionStat <span class="hljs-keyword">struct</span> &#123;<br>  Device     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;device&quot;`</span><br>  Mountpoint <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;mountpoint&quot;`</span><br>  Fstype     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;fstype&quot;`</span><br>  Opts       <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;opts&quot;`</span><br>&#125;<br><br></code></pre></td></tr></table></figure>

<p><code>Device</code>：分区标识，在 Windows 上即为<code>C:</code>这类格式；</p>
<p><code>Mountpoint</code>：挂载点，即该分区的文件路径起始位置；</p>
<p><code>Fstype</code>：文件系统类型，Windows 常用的有 FAT、NTFS 等，Linux 有 ext、ext2、ext3等；</p>
<p><code>Opts</code>：选项，与系统相关。</p>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  infos, _ := disk.Partitions(<span class="hljs-literal">false</span>)<br>  <span class="hljs-keyword">for</span> _, info := <span class="hljs-keyword">range</span> infos &#123;<br>    data, _ := json.MarshalIndent(info, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br>    fmt.Println(<span class="hljs-type">string</span>(data))<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出包括所有分区，我这里只展示一个：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">&#123;<br>  <span class="hljs-string">&quot;device&quot;</span>: <span class="hljs-string">&quot;/dev/nvme0n1p8&quot;</span>,<br>  <span class="hljs-string">&quot;mountpoint&quot;</span>: <span class="hljs-string">&quot;/&quot;</span>,<br>  <span class="hljs-string">&quot;fstype&quot;</span>: <span class="hljs-string">&quot;ext4&quot;</span>,<br>  <span class="hljs-string">&quot;opts&quot;</span>: <span class="hljs-string">&quot;rw,relatime&quot;</span><br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>使用率</strong></p>
<p>调用<code>disk.Usage(path string)</code>即可获得路径<code>path</code>所在磁盘的使用情况，返回一个<code>UsageStat</code>结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// src/github.com/shirou/gopsutil/disk.go</span><br><span class="hljs-keyword">type</span> UsageStat <span class="hljs-keyword">struct</span> &#123;<br>  Path              <span class="hljs-type">string</span>  <span class="hljs-string">`json:&quot;path&quot;`</span><br>  Fstype            <span class="hljs-type">string</span>  <span class="hljs-string">`json:&quot;fstype&quot;`</span><br>  Total             <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;total&quot;`</span><br>  Free              <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;free&quot;`</span><br>  Used              <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;used&quot;`</span><br>  UsedPercent       <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;usedPercent&quot;`</span><br>  InodesTotal       <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;inodesTotal&quot;`</span><br>  InodesUsed        <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;inodesUsed&quot;`</span><br>  InodesFree        <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;inodesFree&quot;`</span><br>  InodesUsedPercent <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;inodesUsedPercent&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li><code>Path</code>：路径，传入的参数；</li>
<li><code>Fstype</code>：文件系统类型；</li>
<li><code>Total</code>：该分区总容量；</li>
<li><code>Free</code>：空闲容量；</li>
<li><code>Used</code>：已使用的容量；</li>
<li><code>UsedPercent</code>：使用百分比</li>
</ul>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  info, _ := disk.Usage(<span class="hljs-string">&quot;/home&quot;</span>)<br>  data, _ := json.MarshalIndent(info, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot;  &quot;</span>)<br>  fmt.Println(<span class="hljs-type">string</span>(data))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于返回的是磁盘的使用情况，所以路径<code>/home和/:</code>返回同样的结果，只是结构中的<code>Path</code>字段不同而已。程序输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">&#123;<br>  <span class="hljs-string">&quot;path&quot;</span>: <span class="hljs-string">&quot;/&quot;</span>,<br>  <span class="hljs-string">&quot;fstype&quot;</span>: <span class="hljs-string">&quot;ext2/ext3&quot;</span>,<br>  <span class="hljs-string">&quot;total&quot;</span>: <span class="hljs-number">665553149952</span>,<br>  <span class="hljs-string">&quot;free&quot;</span>: <span class="hljs-number">535020593152</span>,<br>  <span class="hljs-string">&quot;used&quot;</span>: <span class="hljs-number">96649084928</span>,<br>  <span class="hljs-string">&quot;usedPercent&quot;</span>: <span class="hljs-number">15.300573746356008</span>,<br>  <span class="hljs-string">&quot;inodesTotal&quot;</span>: <span class="hljs-number">41345024</span>,<br>  <span class="hljs-string">&quot;inodesUsed&quot;</span>: <span class="hljs-number">1743985</span>,<br>  <span class="hljs-string">&quot;inodesFree&quot;</span>: <span class="hljs-number">39601039</span>,<br>  <span class="hljs-string">&quot;inodesUsedPercent&quot;</span>: <span class="hljs-number">4.218125499213642</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="主机"><a href="#主机" class="headerlink" title="主机"></a>主机</h3><p>子包<code>host</code>可以获取主机相关信息，如开机时间、内核版本号、平台信息等等</p>
<p><strong>开机时间</strong></p>
<p><code>host.BootTime()</code>返回主机开机时间的时间戳：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  timestamp, _ := host.BootTime()<br>  t := time.Unix(<span class="hljs-type">int64</span>(timestamp), <span class="hljs-number">0</span>)<br>  fmt.Println(t.Local().Format(<span class="hljs-string">&quot;2006-01-02 15:04:05&quot;</span>))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上面先获取开机时间，然后通过<code>time.Unix()</code>将其转为<code>time.Time</code>类型，最后输出<code>2006-01-02 15:04:05</code>格式的时间：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">2024-08-12 08:54:18<br></code></pre></td></tr></table></figure>



<p><strong>内核版本和平台信息</strong></p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	version, _ := host.KernelVersion()<br>	fmt.Println(version)<br><br>	platform, family, version, _ := host.PlatformInformation()<br>	fmt.Println(<span class="hljs-string">&quot;platform:&quot;</span>, platform)<br>	fmt.Println(<span class="hljs-string">&quot;family:&quot;</span>, family)<br>	fmt.Println(<span class="hljs-string">&quot;version:&quot;</span>, version)<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行输出：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-number">6.5</span><span class="hljs-number">.0</span><span class="hljs-number">-28</span>-generic<br>platform: debian<br>family: debian<br>version: bookworm/sid<br></code></pre></td></tr></table></figure>



<p><strong>终端用户</strong></p>
<p><code>host.Users()</code>返回终端连接上来的用户信息，每个用户一个<code>UserStat</code>结构：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// src/github.com/shirou/gopsutil/host/host.go</span><br><span class="hljs-keyword">type</span> UserStat <span class="hljs-keyword">struct</span> &#123;<br>  User     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;user&quot;`</span><br>  Terminal <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;terminal&quot;`</span><br>  Host     <span class="hljs-type">string</span> <span class="hljs-string">`json:&quot;host&quot;`</span><br>  Started  <span class="hljs-type">int</span>    <span class="hljs-string">`json:&quot;started&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>实例：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  users, _ := host.Users()<br>  <span class="hljs-keyword">for</span> _, user := <span class="hljs-keyword">range</span> users &#123;<br>    data, _ := json.MarshalIndent(user, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot; &quot;</span>)<br>    fmt.Println(<span class="hljs-type">string</span>(data))<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs go">&#123;<br> <span class="hljs-string">&quot;user&quot;</span>: <span class="hljs-string">&quot;gond&quot;</span>,<br> <span class="hljs-string">&quot;terminal&quot;</span>: <span class="hljs-string">&quot;tty2&quot;</span>,<br> <span class="hljs-string">&quot;host&quot;</span>: <span class="hljs-string">&quot;tty2&quot;</span>,<br> <span class="hljs-string">&quot;started&quot;</span>: <span class="hljs-number">1723424126</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="内存"><a href="#内存" class="headerlink" title="内存"></a>内存</h3><p>在<code>快速使用</code>中，我们演示了如何使用<code>mem.VirtualMemory()</code>来获取内存信息。该函数返回的只是物理内存信息。我们还可以使用<code>mem.SwapMemory()</code>获取交换内存的信息，信息存储在结构<code>SwapMemoryStat</code>中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-comment">// src/github.com/shirou/gopsutil/mem/</span><br><span class="hljs-keyword">type</span> SwapMemoryStat <span class="hljs-keyword">struct</span> &#123;<br>  Total       <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;total&quot;`</span><br>  Used        <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;used&quot;`</span><br>  Free        <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;free&quot;`</span><br>  UsedPercent <span class="hljs-type">float64</span> <span class="hljs-string">`json:&quot;usedPercent&quot;`</span><br>  Sin         <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;sin&quot;`</span><br>  Sout        <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;sout&quot;`</span><br>  PgIn        <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;pgin&quot;`</span><br>  PgOut       <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;pgout&quot;`</span><br>  PgFault     <span class="hljs-type">uint64</span>  <span class="hljs-string">`json:&quot;pgfault&quot;`</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>字段含义很容易理解，<code>PgIn/PgOut/PgFault</code>这三个字段我们重点介绍一下。交换内存是以<strong>页</strong>为单位的，如果出现缺页错误(<code>page fault</code>)，操作系统会将磁盘中的某些页载入内存，同时会根据特定的机制淘汰一些内存中的页。<code>PgIn</code>表征载入页数，<code>PgOut</code>淘汰页数，<code>PgFault</code>缺页错误数。</p>
<p>例如：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  swapMemory, _ := mem.SwapMemory()<br>  data, _ := json.MarshalIndent(swapMemory, <span class="hljs-string">&quot;&quot;</span>, <span class="hljs-string">&quot; &quot;</span>)<br>  fmt.Println(<span class="hljs-type">string</span>(data))<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h3><p><code>process</code>可用于获取系统当前运行的进程信息，创建新进程，对进程进行一些操作等。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>  <span class="hljs-keyword">var</span> rootProcess *process.Process<br>  processes, _ := process.Processes()<br>  <span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> processes &#123;<br>    <span class="hljs-keyword">if</span> p.Pid == <span class="hljs-number">0</span> &#123;<br>      rootProcess = p<br>      <span class="hljs-keyword">break</span><br>    &#125;<br>  &#125;<br><br>  fmt.Println(rootProcess)<br><br>  fmt.Println(<span class="hljs-string">&quot;children:&quot;</span>)<br>  children, _ := rootProcess.Children()<br>  <span class="hljs-keyword">for</span> _, p := <span class="hljs-keyword">range</span> children &#123;<br>    fmt.Println(p)<br>  &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>先调用<code>process.Processes()</code>获取当前系统中运行的所有进程，然后找到<code>Pid</code>为 0 的进程，即操作系统的第一个进程，最后调用<code>Children()</code>返回其子进程。还有很多方法可获取进程信息，感兴趣可查看文档了解</p>
<h2 id="ants-协程池"><a href="#ants-协程池" class="headerlink" title="ants(协程池)"></a>ants(协程池)</h2><h3 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h3><p>处理大量并发是 Go 语言的一大优势。语言内置了方便的并发语法，可以非常方便的创建很多个轻量级的 goroutine 并发处理任务。相比于创建多个线程，goroutine 更轻量、资源占用更少、切换速度更快、无线程上下文切换开销更少。但是受限于资源总量，系统中能够创建的 goroutine 数量也是受限的。默认每个 goroutine 占用 8KB 内存，一台 8GB 内存的机器满打满算也只能创建 8GB&#x2F;8KB &#x3D; 1000000 个 goroutine，更何况系统还需要保留一部分内存运行日常管理任务，go 运行时需要内存运行 gc、处理 goroutine 切换等。使用的内存超过机器内存容量，系统会使用交换区（swap），导致性能急速下降</p>
<h3 id="快速使用-5"><a href="#快速使用-5" class="headerlink" title="快速使用"></a>快速使用</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">go</span> get -u github.com/panjf2000/ants/v2<br></code></pre></td></tr></table></figure>

<p>ants的使用有四种方式，分别如下：</p>
<p><img src="https://github.com/gondmhd/blogImage/blob/main/img/image-20240904161834137.png?raw=true" srcset="/img/loading.gif" lazyload alt="image-20240904161834137"></p>
<p>这四种使用方式，前两种最常用，基本能满足日常系统的开发需要，第四种默认池，简单的场景也可以用，但不推荐，多池的情况还没想到特别合适的应用场景。</p>
<h3 id="使用方式详解"><a href="#使用方式详解" class="headerlink" title="使用方式详解"></a>使用方式详解</h3><h4 id="默认池"><a href="#默认池" class="headerlink" title="默认池"></a>默认池</h4><p>ants在启动时，会默认初始化一个协程池，这部分代码位于ants.go文件中：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">var</span> (<br>	<span class="hljs-comment">// ErrLackPoolFunc will be returned when invokers don&#x27;t provide function for pool.</span><br>	ErrLackPoolFunc = errors.New(<span class="hljs-string">&quot;must provide function for pool&quot;</span>)<br> <br>	<span class="hljs-comment">// ErrInvalidPoolExpiry will be returned when setting a negative number as the periodic duration to purge goroutines.</span><br>	ErrInvalidPoolExpiry = errors.New(<span class="hljs-string">&quot;invalid expiry for pool&quot;</span>)<br> <br>	<span class="hljs-comment">// ErrPoolClosed will be returned when submitting task to a closed pool.</span><br>	ErrPoolClosed = errors.New(<span class="hljs-string">&quot;this pool has been closed&quot;</span>)<br> <br>	<span class="hljs-comment">// ErrPoolOverload will be returned when the pool is full and no workers available.</span><br>	ErrPoolOverload = errors.New(<span class="hljs-string">&quot;too many goroutines blocked on submit or Nonblocking is set&quot;</span>)<br> <br>	<span class="hljs-comment">// ErrInvalidPreAllocSize will be returned when trying to set up a negative capacity under PreAlloc mode.</span><br>	ErrInvalidPreAllocSize = errors.New(<span class="hljs-string">&quot;can not set up a negative capacity under PreAlloc mode&quot;</span>)<br> <br>	<span class="hljs-comment">// ErrTimeout will be returned after the operations timed out.</span><br>	ErrTimeout = errors.New(<span class="hljs-string">&quot;operation timed out&quot;</span>)<br> <br>	<span class="hljs-comment">// ErrInvalidPoolIndex will be returned when trying to retrieve a pool with an invalid index.</span><br>	ErrInvalidPoolIndex = errors.New(<span class="hljs-string">&quot;invalid pool index&quot;</span>)<br> <br>	<span class="hljs-comment">// ErrInvalidLoadBalancingStrategy will be returned when trying to create a MultiPool with an invalid load-balancing strategy.</span><br>	ErrInvalidLoadBalancingStrategy = errors.New(<span class="hljs-string">&quot;invalid load-balancing strategy&quot;</span>)<br> <br>	<span class="hljs-comment">// workerChanCap determines whether the channel of a worker should be a buffered channel</span><br>	<span class="hljs-comment">// to get the best performance. Inspired by fasthttp at</span><br>	<span class="hljs-comment">// https://github.com/valyala/fasthttp/blob/master/workerpool.go#L139</span><br>	workerChanCap = <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> <span class="hljs-type">int</span> &#123;<br>		<span class="hljs-comment">// Use blocking channel if GOMAXPROCS=1.</span><br>		<span class="hljs-comment">// This switches context from sender to receiver immediately,</span><br>		<span class="hljs-comment">// which results in higher performance (under go1.5 at least).</span><br>		<span class="hljs-keyword">if</span> runtime.GOMAXPROCS(<span class="hljs-number">0</span>) == <span class="hljs-number">1</span> &#123;<br>			<span class="hljs-keyword">return</span> <span class="hljs-number">0</span><br>		&#125;<br> <br>		<span class="hljs-comment">// Use non-blocking workerChan if GOMAXPROCS&gt;1,</span><br>		<span class="hljs-comment">// since otherwise the sender might be dragged down if the receiver is CPU-bound.</span><br>		<span class="hljs-keyword">return</span> <span class="hljs-number">1</span><br>	&#125;()<br> <br>	<span class="hljs-comment">// log.Lmsgprefix is not available in go1.13, just make an identical value for it.</span><br>	logLmsgprefix = <span class="hljs-number">64</span><br>	defaultLogger = Logger(log.New(os.Stderr, <span class="hljs-string">&quot;[ants]: &quot;</span>, log.LstdFlags|logLmsgprefix|log.Lmicroseconds))<br> <br>	<span class="hljs-comment">// Init an instance pool when importing ants.</span><br>	defaultAntsPool, _ = NewPool(DefaultAntsPoolSize)<br>)<br></code></pre></td></tr></table></figure>

<p>使用起来就比较简单，直接往池子里提交任务即可。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;github.com/panjf2000/ants/v2&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br>)<br><br><span class="hljs-comment">// 默认池</span><br><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addsum</span><span class="hljs-params">(d <span class="hljs-type">int</span>)</span></span> &#123;<br>	sum := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; d; i++ &#123;<br>		sum += i<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;sum is ：&quot;</span>, sum)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br>	now := time.Now()<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>		wg.Add(<span class="hljs-number">1</span>)<br>		ants.Submit(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			addsum(<span class="hljs-number">1000000000</span>)<br>			wg.Done()<br>		&#125;)<br>	&#125;<br><br>	wg.Wait()<br>	fmt.Println(<span class="hljs-string">&quot;协程池运行时间:&quot;</span>, time.Since(now))<br>	now = time.Now()<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>		addsum(<span class="hljs-number">1000000000</span>)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;主线程运行时间:&quot;</span>, time.Since(now))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>运行结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>协程池运行时间: <span class="hljs-number">460.392277</span>ms<br>sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>sum is ： <span class="hljs-number">499999999500000000</span><br>主线程运行时间: <span class="hljs-number">2.176051363</span>s<br></code></pre></td></tr></table></figure>



<h4 id="普通模式"><a href="#普通模式" class="headerlink" title="普通模式"></a>普通模式</h4><p>普通模式和使用默认池非常类似，但是需要自己创建一个线程池：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs go">p, _ := ants.NewPool(<span class="hljs-number">5</span>)<br></code></pre></td></tr></table></figure>

<p>函数参数为协程池协程个数，测试代码如下：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br> <br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br> <br>	<span class="hljs-string">&quot;github.com/panjf2000/ants/v2&quot;</span><br>)<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(d <span class="hljs-type">int</span>)</span></span> &#123;<br>	sum := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; d; i++ &#123;<br>		sum += i<br>	&#125;<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br>	now := time.Now()<br>	p, _ := ants.NewPool(<span class="hljs-number">5</span>)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>		wg.Add(<span class="hljs-number">1</span>)<br>		p.Submit(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">()</span></span> &#123;<br>			add(<span class="hljs-number">10000000000</span>)<br>			wg.Done()<br>		&#125;)<br>	&#125;<br>	wg.Wait()<br>	fmt.Println(<span class="hljs-string">&quot;协程池运行：&quot;</span>, time.Since(now))<br>	now = time.Now()<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>		add(<span class="hljs-number">10000000000</span>)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;循环运行：&quot;</span>, time.Since(now))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs go">协程池运行： <span class="hljs-number">221.90558</span>ms<br>循环运行： <span class="hljs-number">1.059491865</span>s<br></code></pre></td></tr></table></figure>

<h4 id="带参函数"><a href="#带参函数" class="headerlink" title="带参函数"></a>带参函数</h4><p>带参函数，重点是往worker中传递函数执行的参数，每个workder中都是同一个执行函数。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br> <br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br> <br>	<span class="hljs-string">&quot;github.com/panjf2000/ants/v2&quot;</span><br>)<br> <br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">add</span><span class="hljs-params">(d <span class="hljs-type">int</span>)</span></span> &#123;<br>	sum := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; d; i++ &#123;<br>		sum += i<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;the sum is: &quot;</span>, sum)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br>	now := time.Now()<br>	p, _ := ants.NewPoolWithFunc(<span class="hljs-number">5</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>		add(i.(<span class="hljs-type">int</span>))<br>		wg.Done()<br>	&#125;)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; <span class="hljs-number">5</span>; i++ &#123;<br>		wg.Add(<span class="hljs-number">1</span>)<br>		p.Invoke(<span class="hljs-number">1000000000</span>)<br>	&#125;<br>	wg.Wait()<br>	fmt.Println(<span class="hljs-string">&quot;循环运行：&quot;</span>, time.Since(now))<br>&#125;<br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs go">the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>协程池运行： <span class="hljs-number">448.830883</span>ms<br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>循环运行： <span class="hljs-number">2.142860462</span>s<br></code></pre></td></tr></table></figure>

<h4 id="多池多协程"><a href="#多池多协程" class="headerlink" title="多池多协程"></a>多池多协程</h4><p>这种模式，就是声明了多个协程池，每个池子里有多个协程在跑。</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs go"><span class="hljs-keyword">package</span> main<br><br><span class="hljs-keyword">import</span> (<br>	<span class="hljs-string">&quot;fmt&quot;</span><br>	<span class="hljs-string">&quot;sync&quot;</span><br>	<span class="hljs-string">&quot;time&quot;</span><br><br>	<span class="hljs-string">&quot;github.com/panjf2000/ants/v2&quot;</span><br>)<br><br><span class="hljs-comment">// 多池多协程</span><br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">addsum3</span><span class="hljs-params">(d <span class="hljs-type">int</span>)</span></span> &#123;<br>	sum := <span class="hljs-number">0</span><br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; d; i++ &#123;<br>		sum += i<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;the sum is: &quot;</span>, sum)<br>&#125;<br><span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> &#123;<br>	<span class="hljs-keyword">var</span> wg sync.WaitGroup<br>	runTimes := <span class="hljs-number">10</span><br>	now := time.Now()<br>	mpf, _ := ants.NewMultiPoolWithFunc(<span class="hljs-number">10</span>, runTimes/<span class="hljs-number">5</span>, <span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(i <span class="hljs-keyword">interface</span>&#123;&#125;)</span></span> &#123;<br>		<span class="hljs-comment">// size 代表要创建的子协程池的总数 sizePerPool（runTimes/5）每个子协程池中的工作线程数量</span><br>		addsum3(i.(<span class="hljs-type">int</span>))<br>		wg.Done()<br>	&#125;, ants.LeastTasks)<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; runTimes; i++ &#123;<br>		wg.Add(<span class="hljs-number">1</span>)<br>		mpf.Invoke(<span class="hljs-number">1000000000</span>)<br>	&#125;<br>	wg.Wait()<br>	fmt.Println(<span class="hljs-string">&quot;协程池运行时间:&quot;</span>, time.Since(now))<br>	now = time.Now()<br>	<span class="hljs-keyword">for</span> i := <span class="hljs-number">0</span>; i &lt; runTimes; i++ &#123;<br>		addsum3(<span class="hljs-number">1000000000</span>)<br>	&#125;<br>	fmt.Println(<span class="hljs-string">&quot;主线程运行时间:&quot;</span>, time.Since(now))<br>&#125;<br><br></code></pre></td></tr></table></figure>

<p>输出结果：</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><code class="hljs go">the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>协程池运行时间: <span class="hljs-number">739.516116</span>ms<br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>the sum is:  <span class="hljs-number">499999999500000000</span><br>主线程运行时间: <span class="hljs-number">4.2396312</span>s<br></code></pre></td></tr></table></figure>

<h3 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h3><p>普通模式、带参数函数是推荐的使用方式，使用协程池，可以有效的控制系统硬件资源的使用，防止机器被打满，对于高并发服务非常推荐使用。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/Go%E7%AC%94%E8%AE%B0/" class="category-chain-item">Go笔记</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/Go/" class="print-no-link">#Go</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>常用三方库</div>
      <div>http://gondmhd.github.io/2024/12/10/go/常用三方库/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>Gond</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2024年12月10日</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>许可协议</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - 署名">
                    <i class="iconfont icon-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                      <a href="/2024/12/10/go/reflect%E5%8C%85%E5%8F%8D%E5%B0%84/" title="reflect反射笔记">
                        <i class="iconfont icon-arrowleft"></i>
                        <span class="hidden-mobile">reflect反射笔记</span>
                        <span class="visible-mobile">上一篇</span>
                      </a>
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2024/12/10/go/Go%E6%80%A7%E8%83%BD%E5%88%86%E6%9E%90%E5%B7%A5%E5%85%B7pprof/" title="Go性能分析工具pprof">
                        <span class="hidden-mobile">Go性能分析工具pprof</span>
                        <span class="visible-mobile">下一篇</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>目录</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  







    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">搜索</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">关键词</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
    <div class="footer-content">
       <a href="https://hexo.io" target="_blank" rel="nofollow noopener"><span>Hexo</span></a> <i class="iconfont icon-love"></i> <a href="https://github.com/fluid-dev/hexo-theme-fluid" target="_blank" rel="nofollow noopener"><span>Fluid</span></a> 
    </div>
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
